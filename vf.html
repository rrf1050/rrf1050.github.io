<!doctype html>
 
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <title>vf</title>
    <meta name="description" content="かつてJava Appletで作成したゲーム
http://rrfgames.sitemix.jp/vf.html
をphina.jsに移植してみようとサンプルからフォークして作っています。" />
    
    <style>*, *:before, *:after {
  box-sizing: border-box; 
    overflow-y: hidden;
     overflow-x: hidden;
     
}
canvas{
  image-rendering: -moz-crisp-edges;         /* Firefox */
  image-rendering:   -o-crisp-edges;         /* Opera */
  image-rendering: -webkit-optimize-contrast;/* Webkit (非標準の名前) */
  image-rendering: crisp-edges;
  -ms-interpolation-mode: nearest-neighbor;  /* IE (非標準プロパティ) */
  image-rendering: pixelated;
  
  -webkit-font-smoothing: none;
}
html {
  /*font-size: 62.5%;*/

}
body {
  width: 100%;
  color: #444;
  background-color: hsl(0, 0%, 96%);
}
h1 {
  /*font-size: 1.8rem;*/
}

  </style>
  </head>
  <body>
   
   <script src="build/phina.js" crossorigin="anonymous"></script> 
   <!--<script src="http://cdn.rawgit.com/phi-jp/phina.js/v0.2.0/build/phina.js"></script> !-->
    <script>//console.log(Math.pow(2,0.5));
// グローバルに展開
phina.globalize();
// 定数
//window.onerror = function (msg, file, line, column, err) {
    /*
    msg: error message
    file: file path
    line: row number
    column: column number
    err: error object
    */ 
//    alert(msg + file + ':' + line);
//};
var ASSETS = {
  image: {
    bg25: "graphic/haikei25.png",
    yukari_legacy: "graphic/yukari25_c16_4bit.png",
    yukari_origin: "graphic/yukari25_master_master_6bit_origin.png",
    yukari_white:"graphic/yukari25_6bit_white.png",
    maki_origin:"graphic/maki25_6bit_master.png",
    maki_white:"graphic/maki25_6bit_master_white.png",
    maki_bskin:"graphic/maki25_6bit_bskin.png",
    
    maki_thumnail:"graphic/credit/maki_thumnail[1].png",
    yukari_thumnail:"graphic/credit/yukari_thumnail[1].png",
    
    credit_150:"graphic/credit/150shibari.png",
    credit_alknsama:"graphic/credit/alknsama.png",
    credit_contributor:"graphic/credit/contributor.png",
    credit_gamelibrary:"graphic/credit/gamelibrary.png",
    credit_kinosama:"graphic/credit/kinosama.png",
    credit_kinoshiki:"graphic/credit/kinoshiki.png",
    credit_maou:"graphic/credit/maou.png",
    credit_model:"graphic/credit/model.png",
    credit_next:"graphic/credit/next.png",
    credit_phisama:"graphic/credit/phisama.png",
    credit_previous:"graphic/credit/previous.png",
    credit_programming:"graphic/credit/programming.png",
    credit_rrf:"graphic/credit/rrf.png",
    credit_simiraaaasama:"graphic/credit/simiraaaasama.png",
    credit_sound:"graphic/credit/sound.png",
    credit_specialthanks:"graphic/credit/specialthanks.png",
    credit_thematch:"graphic/credit/thematch.png",
    credit_tureduresama:"graphic/credit/tureduresama.png",
    credit_yuurisama:"graphic/credit/yuurisama.png",
    credit_yuurishiki:"graphic/credit/yuurishiki.png",
    credit_ken:"graphic/credit/ken.png",
    
    tutorial_finger:"graphic/tutorial/finger.png",
    tutorial_finger_s:"graphic/tutorial/finger_s.png",
    tutorial_title:"graphic/tutorial/tutorial_title.png",
    tutorial_tex1:"graphic/tutorial/tutorial_tex1.png",
    tutorial_tex2:"graphic/tutorial/tutorial_tex2.png",
    tutorial_tex3:"graphic/tutorial/tutorial_tex3.png",
    tutorial_tex4:"graphic/tutorial/tutorial_tex4.png",
    
    back: "graphic/surface/Back.png",
    charactor: "graphic/surface/charactor.png",
    color: "graphic/surface/Color.png",
    entry: "graphic/surface/Entry.png",
    c_maki: "graphic/surface/Maki.png",
    c_yukari: "graphic/surface/Yukari.png",
    settings: "graphic/surface/Settings.png",
    title: "graphic/surface/title.png",
    exit: "graphic/surface/Exit.png",
    tutorial: "graphic/surface/tutorial.png",
    credit: "graphic/surface/credit.png",
    origin: "graphic/surface/Origin.png",
    legacy: "graphic/surface/Legacy.png",
    white: "graphic/surface/White.png",
    bskin: "graphic/surface/bskin.png",
    settings_t: "graphic/settings/settings_t.png",
    game_settings: "graphic/settings/game_settings.png",
    sound_settings: "graphic/settings/sound_settings.png",
    back_s: "graphic/settings/back_s.png",
    game_settings_t:"graphic/settings/game_settings_t.png",
    game_num:"graphic/settings/game_num.png",
    deuce:"graphic/settings/deuce.png",
    cpu_vs_cpu:"graphic/settings/cpu_vs_cpu.png",
    gn1:"graphic/settings/gn1.png",
    gn2:"graphic/settings/gn2.png",
    gn3:"graphic/settings/gn3.png",
    gn4:"graphic/settings/gn4.png",
    gn5:"graphic/settings/gn5.png",
    on: "graphic/settings/on.png",
    off:"graphic/settings/off.png",
    sound_settings_t:"graphic/settings/sound_settings_t.png",
    se:"graphic/settings/se.png",
    bgm:"graphic/settings/bgm.png",
    cursor: "graphic/settings/cursor.png",
    exit_message:"graphic/exit/exit_message.png",
    yes: "graphic/exit/yes.png",
    no: "graphic/exit/no.png",
    
    ready: "graphic/decolate/Ready.png",
    fight: "graphic/decolate/Fight.png",
    you_r: "graphic/decolate/you_r.png",
    you_b: "graphic/decolate/you_b.png",
    win: "graphic/decolate/win.png",
    lose: "graphic/decolate/lose.png",
    
    logo: "graphic/logo/logo.png",
    logo_c: "graphic/credit/phinajs.png",
    
    result_yukari:"graphic/result/result_yukari.png",
    result_maki:"graphic/result/result_maki.png",
  },
	spritesheet: {
		"yukari_legacy_ss":"ss/yukari25_c16.json",
		"yukari_origin_ss":"ss/yukari25_master.json",
		"maki_origin_ss":"ss/maki25_master.json",
	},
	json: {
	  hantei0: 'hantei/backstep/backstephantei.txt.json',
	  hantei1: 'hantei/backwalk/backwalkhantei.txt.json',
	  hantei2: 'hantei/counterdamage/counterdamagehantei.txt.json',
	  hantei3: 'hantei/damage/damagehantei.txt.json',
	  hantei4: 'hantei/dash/dashhantei.txt.json',
	  hantei5: 'hantei/down/downhantei.txt.json',
	  hantei6: 'hantei/idol/idolhantei.txt.json',
	  hantei7: 'hantei/jdamage/jdamagehantei.txt.json',
	  hantei8: 'hantei/jrslash/jrslashhantei.txt.json',
	  hantei9: 'hantei/jslash/jslashhantei.txt.json',
	  hantei10: 'hantei/jump/jumphantei.txt.json',
	  hantei11: 'hantei/sdamage/sdamagehantei.txt.json',
	  hantei12: 'hantei/shirimochi/shirimochihantei.txt.json',
	  hantei13: 'hantei/sit/sithantei.txt.json',
	  hantei14: 'hantei/slash1/slashhantei.txt.json',
	  hantei15: 'hantei/sslash/sslashhantei.txt.json',
	  hantei16: 'hantei/wakeup/wakeuphantei.txt.json',
	  hantei17: 'hantei/walk/walkhantei.txt.json',
	  hantei18: 'hantei/winpose/winposehantei.txt.json',
	  hantei19: 'hantei/wintoidol/wintoidolhantei.txt.json',
	  hantei20: 'hantei/backwalkbegin/backwalkbeginhantei.txt.json',
	  hantei21: 'hantei/walkbegin/walkbeginhantei.txt.json',
	  hantei22: 'hantei/standup/standuphantei.txt.json',
	  hantei23: 'hantei/sitdown/sitdownhantei.txt.json',
	  hantei24: 'hantei/jdamage_keep/jdamage_keephantei.txt.json',
	},
	sound: {
	  cancel: 'se/cancel.wav',
	  chit: 'se/chit.wav',
	  cursor: 'se/cursor.wav',
	  enter: 'se/enter.wav',
	  fight: 'se/fight.wav',
	  jhit: 'se/jhit.wav',
	  karaburi: 'se/karaburi.wav',
	  sousai: 'se/metal.wav',
	  ready: 'se/ready.wav',
	  slash: 'se/slash.wav',
	  todome: 'se/todome.wav',
	  
	  lobby: 'bgm/c13.mp3',
	  battle: "bgm/n51.mp3",
	  win: 'bgm/win.mp3',
	  lose: 'bgm/lose.mp3',
	  splash_zunko: "se/splash.wav",
	  splash_maki: "se/splash_maki.wav",
	  splash_yukari: "se/splash_yukari.wav",
	},
	font:{
	  mypixel: "font/minikstt.woff",
	}
};

var FOUR = 4;
var SCREEN_WIDTH  = 960/FOUR;              // スクリーン幅
var SCREEN_HEIGHT = 540/FOUR;              // スクリーン高さ
var SPEED         = 10;


phina.define("GameInput",{
  init: function(){
    this.a=false;
    this.b=false;
    this.left=false;
    this.right=false;
    this.up=false;
    this.down=false;
  }
});
phina.define("GameConsole",{
  
  init: function(name,parentname,elements,owner,x,controlobj){
    this.controlobj = controlobj;
    this.keyqueue=[];
    this.name = name;
    this.parentname = parentname;
    this.elements = elements;
    this.objects = [];
    this.owner = owner;
    this.parent = DisplayElement().addChildTo(owner);
    if (name == "tutorial"){
      this.openflag=false;
      this.pre_visible=false;
      this.board = DisplayElement().addChildTo(this.parent);
      this.board.Iterator = 0;
      this.Iterator = 0;
      this.board.x = -SCREEN_WIDTH;
      this.board.y = -SCREEN_HEIGHT;
      this.board.enterflag=false;
      this.backrect = RectangleShape({
        width:SCREEN_WIDTH*3/4,
        height:SCREEN_HEIGHT*3/4,
        fill:"#000",
        stroke:"false"
      }).addChildTo(this.board);
      this.backrect.alpha=0.5;
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      
      this.previouse_t = Sprite("credit_previous").addChildTo(this.board);
      this.previouse_t.originX=0;
      this.previouse_t.x=-SCREEN_WIDTH*2/5+5;
      this.previouse_t.y=SCREEN_HEIGHT/3;
      this.back_t = Sprite("back_s").addChildTo(this.board);
      this.back_t.y=SCREEN_HEIGHT/3;
      this.next_t = Sprite("credit_next").addChildTo(this.board);
      this.next_t.originX=1;
      this.next_t.x=SCREEN_WIDTH*2/5-5;
      this.next_t.y=SCREEN_HEIGHT/3;
      
      var sprite = Sprite("tutorial_title").addChildTo(this.objects[0]);
      sprite.originX=0;
      sprite.x = -SCREEN_WIDTH*2/5+10;
      sprite.y=-SCREEN_HEIGHT/4;
      sprite = Sprite("tutorial_title").addChildTo(this.objects[1]);
      sprite.originX=0;
      sprite.x = -SCREEN_WIDTH*2/5+10;
      sprite.y=-SCREEN_HEIGHT/4;
      sprite= Sprite("tutorial_title").addChildTo(this.objects[2]);
      sprite.originX=0;
      sprite.x = -SCREEN_WIDTH*2/5+10;
      sprite.y=-SCREEN_HEIGHT/4;
      sprite=Sprite("tutorial_title").addChildTo(this.objects[3]);
      sprite.originX=0;
      sprite.x = -SCREEN_WIDTH*2/5+10;
      sprite.y=-SCREEN_HEIGHT/4;
      sprite=Sprite("tutorial_tex1").addChildTo(this.objects[0]);
      sprite.originX=0;
      sprite.x = -SCREEN_WIDTH*2/5+20;
      sprite.y=3;
      sprite = Sprite("tutorial_tex2").addChildTo(this.objects[1]);
      sprite.originX=0;
      sprite.x = -SCREEN_WIDTH*2/5+20;
      sprite.y = 3;
      sprite = Sprite("tutorial_tex3").addChildTo(this.objects[2]);
      sprite.originX=0;
      sprite.x = -SCREEN_WIDTH*2/5+20;
      sprite.y = 3;
      sprite = Sprite("tutorial_tex4").addChildTo(this.objects[3]);
      sprite.originX=0;
      sprite.x = -SCREEN_WIDTH*2/5+20;
      sprite.y = 3;
      
      this.papet = Sprite("yukari_origin").addChildTo(this.objects[0]);
      this.papet.reverse=true;
      this.papet.scale.set(0.5,0.5);
      this.papet.origin.set(0,0);
      this.papet_ss = FrameAnimation("yukari_origin_ss").attachTo(this.papet);
      this.papet_ss.gotoAndPlay("idol");
      var ss = this.papet_ss;
      this.papet.y = -45;
      this.papet.x=-10;
      this.finger_s = Sprite("tutorial_finger_s").addChildTo(this.objects[0]);
      this.finger_s.alpha=0.8;
      this.finger_s.x=42;
      this.finger_s.y=32;
      this.finger = Sprite("tutorial_finger").addChildTo(this.objects[0]);
      this.finger.x=40;
      this.finger.y=30;
      var finger = this.finger;
      var finger_s = this.finger_s;
      this.papet.tweener.clear().wait(1000).call(function(){
        ss.gotoAndPlay("walk");
        finger.tweener.clear().set({x:40,y:30}).to({x:80},100);
        finger_s.tweener.clear().set({x:42,y:32}).to({x:82},100);
      }).wait(2000).call(function(){
        ss.gotoAndPlay("idol");
        finger.tweener.clear().set({x:85,y:25}).wait(500).to({x:45},100).wait(500).set({x:40,y:30});
        finger_s.tweener.clear().set({x:87,y:37}).wait(500).to({x:47},100).wait(500).set({x:42,y:32});
      }).wait(1000).setLoop(true);
      
     
      this.papet = Sprite("yukari_origin").addChildTo(this.objects[1]);
      this.papet.reverse=true;
      this.papet.scale.set(0.5,0.5);
      this.papet.origin.set(0,0);
      this.papet_ss = FrameAnimation("yukari_origin_ss").attachTo(this.papet);
      this.papet_ss.gotoAndPlay("idol");
      var ss2 = this.papet_ss;
      this.papet.y = -45;
      this.papet.x=-10;
      
      this.finger_s = Sprite("tutorial_finger_s").addChildTo(this.objects[1]);
      this.finger_s.alpha=0.8;
      this.finger_s.x = 82;
      this.finger_s.y= -8;
      
      this.finger = Sprite("tutorial_finger").addChildTo(this.objects[1]);
      this.finger.x = 80;
      this.finger.y= -10;
      var finger2 = this.finger;
      var finger_s2 = this.finger_s;
      this.papet.tweener.clear().call(function(){
        ss2.gotoAndPlay("sitdown");
        finger2.tweener.clear().set({x:80,y:-10}).to({y:30},100);
        finger_s2.tweener.clear().set({x:82,y:-8}).to({y:32},100);
      }).wait(2000).call(function(){
        ss2.gotoAndPlay("standup");
        finger2.tweener.clear().set({x:85,y:25}).wait(500).to({y:-15},100).wait(500).set({x:80,y:-10});
        finger_s2.tweener.clear().set({x:87,y:35}).wait(500).to({y:-5},100).wait(500).set({x:82,y:-8});
      }).wait(2000).setLoop(true);
      
     
      this.papet = Sprite("yukari_origin").addChildTo(this.objects[2]);
      this.papet.reverse=true;
      this.papet.scale.set(0.5,0.5);
      this.papet.origin.set(0,0);
      this.papet_ss = FrameAnimation("yukari_origin_ss").attachTo(this.papet);
      this.papet_ss.gotoAndPlay("idol");
      this.papet_jump_ss = this.papet_ss;
      this.papet_jump=this.papet;
      this.papet_jump.flag=false;
      var papet_jump = this.papet_jump;
      this.papet.y = -45;
      this.papet.x=-10;
      this.finger_s = Sprite("tutorial_finger_s").addChildTo(this.objects[2]);
      this.finger_s.alpha=0.8;
      this.finger_s.x = 82;
      this.finger_s.y= 32;
      
      this.finger = Sprite("tutorial_finger").addChildTo(this.objects[2]);
      this.finger.x = 80;
      this.finger.y= 30;
      var finger3 = this.finger;
      var finger_s3 = this.finger_s;
      this.papet.tweener.clear().call(function(){
        papet_jump.flag=true;
        finger3.tweener.clear().set({x:80,y:30}).to({y:-10},100);
        finger_s3.tweener.clear().set({x:82,y:32}).to({y:-8},100);
      }).wait(2000).call(function(){
        papet_jump.flag=false;
        finger3.tweener.clear().set({x:85,y:-15}).wait(500).to({y:25},100).wait(500).set({x:80,y:30});
        finger_s3.tweener.clear().set({x:85,y:-3}).wait(500).to({y:37},100).wait(500).set({x:82,y:32});
      }).wait(2000).setLoop(true);
      
      this.papet = Sprite("yukari_origin").addChildTo(this.objects[3]);
      this.papet.reverse=true;
      this.papet.scale.set(0.5,0.5);
      this.papet.origin.set(0,0);
      this.papet_ss = FrameAnimation("yukari_origin_ss").attachTo(this.papet);
      this.papet_ss.gotoAndPlay("idol");
      this.papet_slash_ss = this.papet_ss;
      this.papet_slash=this.papet;
      this.papet_slash.flag=false;
      var papet_slash = this.papet_slash;
      var papet_slash_ss = this.papet_slash_ss;
      this.papet.y = -45;
      this.papet.x=-10;
      this.finger_s = Sprite("tutorial_finger_s").addChildTo(this.objects[3]);
      this.finger_s.alpha=0.8;
      this.finger_s.x=82;
      this.finger_s.y=-8;
      this.finger = Sprite("tutorial_finger").addChildTo(this.objects[3]);
      this.finger.x = 80;
      this.finger.y=-10;
      var finger4 = this.finger;
      var finger_s4 = this.finger_s;
      this.finger_s = Sprite("tutorial_finger_s").addChildTo(this.objects[3]);
      this.finger_s.scaleX=-1;
      this.finger_s.alpha=0.8;
      this.finger_s.x=42;
      this.finger_s.y=32;
      this.finger = Sprite("tutorial_finger").addChildTo(this.objects[3]);
      this.finger.scaleX=-1;
      this.finger.x = 40;
      this.finger.y=30;
      var finger5 = this.finger;
      var finger_s5=this.finger_s;
      this.papet.tweener.clear().call(function(){
        papet_slash.flag=true;
        finger_s5.tweener.clear().set({x:42,y:32});
        finger5.tweener.clear().set({x:40,y:30});
      }).wait(2000).call(function(){
        papet_slash.flag=false;
        finger_s5.tweener.clear().set({x:47,y:37});
        finger5.tweener.clear().set({x:45,y:25});
      }).wait(1000).call(function(){
        finger_s4.tweener.clear().set({x:82,y:-8}).to({y:32},100);
        finger4.tweener.clear().set({x:80,y:-10}).to({y:30},100);
        papet_slash_ss.gotoAndPlay("sitdown");
        papet_slash.sitflag=true;
      }).wait(1000).call(function(){
        papet_slash.flag=true;
        finger_s5.tweener.clear().set({x:42,y:32});
        finger5.tweener.clear().set({x:40,y:30});
      }).wait(2000).call(function(){
        papet_slash.flag=false;
        papet_slash.sitflag=false;
        finger_s5.tweener.clear().set({x:47,y:37});
        finger5.tweener.clear().set({x:45,y:25});
        finger_s4.tweener.clear().set({x:87,y:37}).wait(500).to({y:-3},100).wait(500).set({x:82,y:-8});
        finger4.tweener.clear().set({x:85,y:25}).wait(500).to({y:-15},100).wait(500).set({x:80,y:-10});
      }).wait(2000).setLoop(true);
      
      var self =this;
      
      this.previouse_t.setInteractive(true);
      this.previouse_t.onpointend=function(){
        if(this.visible){
          if(0<this.getParent().Iterator){
            this.getParent().Iterator--;
            controlobj.cursorSE.play();
          }
        }
      }
      this.back_t.setInteractive(true);
      this.back_t.onpointend = function(){
        if(this.visible&&self.openflag){
          this.getParent().enterflag=true;
        }
      }
      this.next_t.setInteractive(true);
      var length = this.objects.length;
      this.next_t.onpointend=function(){
        if(this.visible){
          if(this.getParent().Iterator<length-1){
            this.getParent().Iterator++;
            controlobj.cursorSE.play();
          }
        }
      }
      //this.title = Sprite(elements[0]).addChildTo(this.board);
      //this.title.y= -SCREEN_HEIGHT/4;
      
    }
    else if(name=="credit"){
      this.openflag=false;
      this.pre_visible=false;
      this.board = DisplayElement().addChildTo(this.parent);
      this.board.Iterator = 0;
      this.board.x = -SCREEN_WIDTH;
      this.board.y = -SCREEN_HEIGHT;
      this.board.enterflag=false;
      this.backrect = RectangleShape({
        width:SCREEN_WIDTH*3/4,
        height:SCREEN_HEIGHT*3/4,
        fill:"#000",
        stroke:"false"
      }).addChildTo(this.board);
      this.backrect.alpha=0.5;
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.objects.push(DisplayElement().addChildTo(this.board));
      this.title1 = Sprite("credit_model").addChildTo(this.objects[0]);
      this.title1.originX=0;
      this.title1.x=-SCREEN_WIDTH*2/5+10;
      this.title1.y=-SCREEN_HEIGHT/4;
      this.element1_1 = Sprite("credit_kinoshiki").addChildTo(this.objects[0]);
      this.element1_1.x=-SCREEN_WIDTH/6;
      this.element1_1.y=5-10;
      this.element1_2 = Sprite("credit_kinosama").addChildTo(this.objects[0]);
      this.element1_2.x=-SCREEN_WIDTH/6;
      this.element1_2.y=5+10;
      this.element1_3 = Sprite("maki_thumnail").addChildTo(this.objects[0]);
      this.element1_3.x=SCREEN_WIDTH/5;
      
      this.title1 = Sprite("credit_model").addChildTo(this.objects[1]);
      this.title1.originX=0;
      this.title1.x=-SCREEN_WIDTH*2/5+10;
      this.title1.y=-SCREEN_HEIGHT/4;
      this.element1_1 = Sprite("credit_yuurishiki").addChildTo(this.objects[1]);
      this.element1_1.x=-SCREEN_WIDTH/6;
      this.element1_1.y=5-10;
      this.element1_2 = Sprite("credit_yuurisama").addChildTo(this.objects[1]);
      this.element1_2.x=-SCREEN_WIDTH/6;
      this.element1_2.y=5+10;
      this.element1_3 = Sprite("yukari_thumnail").addChildTo(this.objects[1]);
      this.element1_3.x=SCREEN_WIDTH/5;
      
      this.title1 = Sprite("credit_model").addChildTo(this.objects[2]);
      this.title1.originX=0;
      this.title1.x=-SCREEN_WIDTH*2/5+10;
      this.title1.y=-SCREEN_HEIGHT/4;
      this.element1_1 = Sprite("credit_150").addChildTo(this.objects[2]);
      this.element1_1.x=-SCREEN_WIDTH/6;
      this.element1_1.y=5-10;
      this.element1_2 = Sprite("credit_tureduresama").addChildTo(this.objects[2]);
      this.element1_2.x=-SCREEN_WIDTH/6;
      this.element1_2.y=5+10;
      this.element1_3 = Sprite("credit_ken").addChildTo(this.objects[2]);
      this.element1_3.scale.set(0.2,0.2);
      this.element1_3.x=SCREEN_WIDTH/5;
      
      
      this.title1 = Sprite("credit_sound").addChildTo(this.objects[3]);
      this.title1.originX=0;
      this.title1.x=-SCREEN_WIDTH*2/5+10;
      this.title1.y=-SCREEN_HEIGHT/4;
      this.element1_1 = Sprite("se").addChildTo(this.objects[3]);
      this.element1_1.x=-SCREEN_WIDTH/4;
      this.element1_1.y=5-10;
      this.element1_2 = Sprite("bgm").addChildTo(this.objects[3]);
      this.element1_2.x=-SCREEN_WIDTH/4;
      this.element1_2.y=5+10;
      this.element1_3 = Sprite("credit_thematch").addChildTo(this.objects[3]);
      this.element1_3.x=15;
      this.element1_3.y=5-10;
      this.element1_4 = Sprite('credit_maou').addChildTo(this.objects[3]);
      this.element1_4.x=15;
      this.element1_4.y=5+10;
      
      this.title1 = Sprite("credit_gamelibrary").addChildTo(this.objects[4]);
      this.title1.originX=0;
      this.title1.x=-SCREEN_WIDTH*2/5+10;
      this.title1.y=-SCREEN_HEIGHT/4+1;
      var sprite = Sprite("logo_c").addChildTo(this.objects[4]);
      sprite.scale.set(0.25,0.25);
      sprite.y=5;
      var sprite2 = Sprite("credit_phisama").addChildTo(this.objects[4]);
      sprite2.y=28;
      sprite2.x=70;
      
      this.title1 = Sprite("credit_specialthanks").addChildTo(this.objects[5]);
      this.title1.originX=0;
      this.title1.x=-SCREEN_WIDTH*2/5+10;
      this.title1.y=-SCREEN_HEIGHT/4+1;
      var sprite3 = Sprite("credit_alknsama").addChildTo(this.objects[5]);
      sprite3.x = -SCREEN_WIDTH/5;
      sprite3.y=  -5;
      var sprite4 = Sprite("credit_simiraaaasama").addChildTo(this.objects[5]);
      sprite4.x = SCREEN_WIDTH/5;
      sprite4.y= -5;
      var sprite5 = Sprite("credit_contributor").addChildTo(this.objects[5]);
      sprite5.y=13;
      
      this.title1 = Sprite("credit_programming").addChildTo(this.objects[6]);
      this.title1.originX=0;
      this.title1.x=-SCREEN_WIDTH*2/5+10;
      this.title1.y=-SCREEN_HEIGHT/4+1;
      var sprite6 = Sprite("credit_rrf").addChildTo(this.objects[6]);
      
      this.previouse = Sprite("credit_previous").addChildTo(this.board);
      this.previouse.originX=0;
      this.previouse.x=-SCREEN_WIDTH*2/5+5;
      this.previouse.y=SCREEN_HEIGHT/3;
      this.back = Sprite("back_s").addChildTo(this.board);
      this.back.y=SCREEN_HEIGHT/3;
      this.next = Sprite("credit_next").addChildTo(this.board);
      this.next.originX=1;
      this.next.x=SCREEN_WIDTH*2/5-5;
      this.next.y=SCREEN_HEIGHT/3;
      this.objects[0].hide();
      this.objects[1].hide();
      this.objects[2].hide();
      this.objects[3].hide();
      this.objects[4].hide();
      this.objects[5].hide();
      this.previouse.setInteractive(true);
      var self =this;
      this.previouse.onpointend=function(){
        if(this.visible){
          if(0<this.getParent().Iterator){
            this.getParent().Iterator--;
            controlobj.cursorSE.play();
          }
        }
      }
      this.back.setInteractive(true);
      this.back.onpointend = function(){
        if(this.visible&&self.openflag){
          this.getParent().enterflag=true;
        }
      }
      this.next.setInteractive(true);
      var length = this.objects.length;
      this.next.onpointend=function(){
        if(this.visible){
          if(this.getParent().Iterator<length-1){
            controlobj.cursorSE.play();
            this.getParent().Iterator++;
          }
        }
      }
    }
    else if(!name.match("settings")&&name!="exit"){
      var y = 110;
      var y_offset = 12;
      
      
      this.parent.clip = function(canvas){
        canvas.beginPath();
        canvas.rect(x-25,102,52,25);
      };
      this.list = DisplayElement().addChildTo(this.parent);
      this.dummy = DisplayElement().addChildTo(this.list);
      this.dummy.origin.set(0.5,0);
      this.dummy.x=x;
      this.dummy.y=102;
      this.dummy.width=52;
      this.dummy.height=25;
      
      this.dummy.enterflag=false;
      this.dummy.upflag=false;
      this.dummy.downflag=false;
      
      if(this.name != "entry"&&elements.length!==0){
        Math.floor(5/elements.length+1).times(function(){
          elements.forEach(function(element){
            var sprite = Sprite(element).addChildTo(this.list);
            sprite.origin.set(0.5,0);
            sprite.x = x;
            sprite.y = 0;
            this.objects.push(sprite);
          },this);
        },this);
        this.objects[0].y=y;
        this.objects[1].y=y+y_offset;
        this.objects[2].y=y+y_offset*2;
        this.objects[this.objects.length-1].y=y-y_offset;
        this.objects[this.objects.length-2].y=y-y_offset*2;
      }
    }
    else if(name.match("settings")){
      this.board = DisplayElement().addChildTo(this.parent);
      this.board.enterflag=false;
      this.board.Iterator=0;
      if(this.name=="settings"){
        this.board.x = -SCREEN_WIDTH;
        this.board.y = -SCREEN_HEIGHT;
      }
      else{
        this.board.x = SCREEN_WIDTH/2;
        this.board.y = SCREEN_HEIGHT/2;
      }
      this.backrect = RectangleShape({width:SCREEN_WIDTH*3/4,height:SCREEN_HEIGHT*3/4,fill:"#000",stroke:"false"}).addChildTo(this.board);
      this.title = Sprite(elements[0]).addChildTo(this.board);
      this.title.y= -SCREEN_HEIGHT/4;
      elements.shift();
      elements.forEach(function(element,i){
        var sprite = Sprite(element).addChildTo(this.board);
        sprite.y = SCREEN_HEIGHT*i/(elements.length*2)-10;
        if(this.name != "settings" && element != "back_s"){
          sprite.originX = 0;
          sprite.x = -50;
        }
        this.objects.push(sprite);
      },this);
      if(this.name == "game_settings"){
        this.gns = [];
        (5).times(function(i){
          var sprite = Sprite("gn"+String(i+1)).addChildTo(this.board);
          sprite.y = -10;
          sprite.x = 50;
          sprite.hide();
          if(i+1==this.controlobj.gn)
            sprite.show();
          this.gns.push(sprite);
        },this);
        this.on_d = Sprite("on").addChildTo(this.board);
        this.on_d.x = 50;
        this.on_d.y = SCREEN_HEIGHT*1/(elements.length*2)-10;
        this.off_d = Sprite("off").addChildTo(this.board);
        this.off_d.x = 50;
        this.off_d.y = SCREEN_HEIGHT*1/(elements.length*2)-10;
        if(this.controlobj.deuce){
          this.on_d.show();
          this.off_d.hide();
        }
        else{
          this.on_d.hide();
          this.off_d.show();
        }
        this.on_cvc = Sprite("on").addChildTo(this.board);
        this.on_cvc.x = 50;
        this.on_cvc.y = SCREEN_HEIGHT*2/(elements.length*2)-10;
        this.off_cvc = Sprite("off").addChildTo(this.board);
        this.off_cvc.x = 50;
        this.off_cvc.y = SCREEN_HEIGHT*2/(elements.length*2)-10;
        if(this.controlobj.cpu_vs_cpu){
          this.on_cvc.show();
          this.off_cvc.hide();
        }
        else{
          this.on_cvc.hide();
          this.off_cvc.show();
        }
      }
      if(this.name == "sound_settings"){
        this.segage = RectangleShape({originX:0,x:-25,y:-10,fill:"#fff",stroke:false,width:100*this.controlobj.se,height:10}).addChildTo(this.board);
        this.segage_dummy = DisplayElement({originX:0,width:100,height:10}).addChildTo(this.segage);
        this.bgmgage = RectangleShape({originX:0,x:-25,y:SCREEN_HEIGHT*1/(elements.length*2)-10,fill:"#fff",stroke:false,width:100*this.controlobj.bgm,height:10}).addChildTo(this.board);
        this.bgmgage_dummy = DisplayElement({originX:0,width:100,height:10}).addChildTo(this.bgmgage);
      }
      if(!phina.isMobile()){
        this.cursor = Sprite("cursor").addChildTo(this.board);
        this.Iterator = 0;
        if(this.name == "settings")
          this.cursor.x = -this.objects[this.Iterator].width/2-10;
        else
          this.cursor.x = this.objects[this.Iterator].x -10;
        this.cursor.y = this.objects[this.Iterator].y;
      }
      this.backrect.alpha=0.5;
      this.openflag=false;
      this.pre_visible=false;
      if(this.name != "settings"){
        this.pre_visible=true;
        this.openflag=true;
      }
      if(this.name=="settings"){
        this.objects.forEach(function(obj,i){
          obj.setInteractive(true);
          obj.onpointend = function(){
            if(this.getParent().getParent().visible){
              this.getParent().enterflag = true;
              this.getParent().Iterator = i;
            }
          };
        },this);
      }
      else if(this.name == "game_settings"){
        this.dummies=[];
        (3).times(function(i){
          var de = DisplayElement({originX:0,x:this.objects[i].x,y:this.objects[i].y,width:110,height:this.objects[i].height}).addChildTo(this.board);
          de.setInteractive(true);
          de.onpointend = function(){
            if(this.getParent().getParent().visible){
              this.getParent().enterflag = true;
              this.getParent().Iterator = i;
            }
          }
          this.dummies.push(de);
        },this);
        this.objects[this.objects.length-1].setInteractive(true);
        var last = this.objects.length-1;
        this.objects[this.objects.length-1].onpointend = function(){
          if(this.getParent().getParent().visible){
              this.getParent().enterflag = true;
              this.getParent().Iterator = last;
            }
        }
      }
      else if(this.name=="sound_settings"){
        var gagemove =function(e){
          var x = Math.floor(e.pointer.position.x);
          var width=0;
          if(x<95){
            width=0;
          }
          else if(x<=195){
            width = x-95;
          }
          else{
            width = 100;
          }
          this.getParent().width = width;
          
        };
        this.segage_dummy.setInteractive(true);
        this.segage_dummy.onpointmove = gagemove;
        this.bgmgage_dummy.setInteractive(true);
        this.bgmgage_dummy.onpointmove = gagemove;
        this.objects[this.objects.length-1].setInteractive(true);
        var last = this.objects.length-1;
        this.objects[this.objects.length-1].onpointend = function(){
          if(this.getParent().getParent().visible){
              this.getParent().enterflag = true;
              this.getParent().Iterator = last;
            }
        }
      }
    }
    else {//name == exit
      this.dummies = [];
      this.board = DisplayElement().addChildTo(this.parent);
      this.board.enterflag=false;
      this.board.Iterator=0;
      this.board.x = -SCREEN_WIDTH;
      this.board.y = -SCREEN_HEIGHT;
      this.backrect = RectangleShape({width:SCREEN_WIDTH*3/4,height:SCREEN_HEIGHT*2/5,fill:"#000",stroke:"false"}).addChildTo(this.board);
      this.title = Sprite(elements[0]).addChildTo(this.board);
      this.title.y= -SCREEN_HEIGHT/8;
      elements.shift();
      elements.forEach(function(element,i){
        var sprite = Sprite(element).addChildTo(this.board);
        sprite.y = SCREEN_HEIGHT/8;
        sprite.x = SCREEN_WIDTH*(i*2-1)/(elements.length*3);
        var dummy = DisplayElement({x:sprite.x,y:sprite.y,width:sprite.width*2,height:sprite.height*2}).addChildTo(this.board);
        this.objects.push(sprite);
        this.dummies.push(dummy);
      },this);
      if(!phina.isMobile()){
        this.cursor = Sprite("cursor").addChildTo(this.board);
        this.Iterator = 1;
        if(this.name == "settings")
          this.cursor.x = -this.objects[this.Iterator].width/2-10;
        else
          this.cursor.x = this.objects[this.Iterator].x -20;
        this.cursor.y = this.objects[this.Iterator].y;
      }
      this.dummies.forEach(function(dummy,i){
        dummy.setInteractive(true);
        dummy.onpointend = function(){
          if(this.getParent().getParent().visible){
            this.getParent().enterflag=true;
            this.getParent().Iterator = i;
          }
        }
      },this);
      this.backrect.alpha=0.5;
      this.openflag=false;
      this.pre_visible=false;
    }
  },
  update: function(pointer,keyboard,owner){
    
    var y = 110;
    var y_offset = 12;
    if(this.name == "tutorial"||this.name == "credit"){
      if(!this.pre_visible){
        this.board.tweener.clear().set({
          x:SCREEN_WIDTH/2,y:120,scaleX:0.1,scaleY:0.1
        }).to({
          x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/2,scaleX:1,scaleY:1
        },500,"easeOutQuart").call(function(){
          this.openflag=true;
        },this);
      }
      if(this.openflag){
        if(this.name=="tutorial"){
          this.papet_jump.y=-45;
          if(this.papet_jump.flag==true&&(this.papet_jump_ss.currentAnimation.self=="idol")){
            this.papet_jump_ss.gotoAndPlay("jump");
          }
          if(this.papet_jump_ss.currentAnimation.self=="jump"){
            var frame = this.papet_jump_ss.currentFrameIndex;
            if(2<frame&&frame<18){
              var JUMP_Y_ = 2.5*Math.pow(frame-9.5,2)-106;
              //var JUMP_DY_ = JUMP_Y_-(2.5*Math.pow(frame-1-9.5,2)-106);
              this.papet_jump.y = JUMP_Y_/FOUR/2-45;
            }
          }
          if(this.papet_slash.sitflag==true&&(this.papet_slash_ss.currentAnimation.self=="idol")){
            this.papet_slash_ss.gotoAndPlay("sitdown");
          }
          if(this.papet_slash.flag==true&&(this.papet_slash_ss.currentAnimation.self=="idol")){
            this.papet_slash_ss.gotoAndPlay("slash");
          }
          if(this.papet_slash.flag==true&&(this.papet_slash_ss.currentAnimation.self=="sit")){
            this.papet_slash_ss.gotoAndPlay("sslash");
          }
        }
        if(!phina.isMobile()){
          var flag;
          if((flag = keyboard.getKeyDown("z"))==true||keyboard.getKeyDown("right")){
            
            if(this.board.Iterator<this.objects.length-1){
              owner.cursorSE.play();
              this.board.Iterator++;
            }
            else if(flag){
              owner.cursorSE.play();
              this.board.Iterator=0;
              this.openflag=false;
              this.pre_visible = false;
              this.board.x = -SCREEN_WIDTH;
              this.board.y = -SCREEN_HEIGHT;
              if(this.name == "tutorial")
                this.papet_jump.y=0;
            return this.parentname;
            }
          }
          else if(keyboard.getKeyDown("x")){
            owner.cancelSE.play();
            this.board.Iterator=0;
            this.openflag=false;
            this.pre_visible = false;
            this.board.x = -SCREEN_WIDTH;
            this.board.y = -SCREEN_HEIGHT;
            if(this.name == "tutorial")
                this.papet_jump.y=0;
            return this.parentname;
          }
          else if(keyboard.getKeyDown("left")){
            if(this.board.Iterator>0){
              owner.cursorSE.play();
              this.board.Iterator--;
            }
          }
        }
        else if(this.board.enterflag){
          this.board.Iterator=0;
          this.board.enterflag=false;
          owner.cancelSE.play();
          this.openflag=false;
          this.pre_visible = false;
          this.board.x = -SCREEN_WIDTH;
          this.board.y = -SCREEN_HEIGHT;
          if(this.name == "tutorial")
            this.papet_jump.y=0;
          return this.parentname;
        }
      }
      this.objects.forEach(function(obj){
        obj.hide();
      });
      this.objects[this.board.Iterator].show();
      if(this.board.Iterator==0){
        if(this.name == "tutorial"){
          this.previouse_t.hide();
        }
        else {
          this.previouse.hide();
        }
      }
      else{
        if(this.name=="tutorial"){
          this.previouse_t.show();
        }
        else{
          this.previouse.show();
        }
      }
      if(this.board.Iterator==this.objects.length-1){
        if(this.name=="tutorial")
          this.next_t.hide();
        else
          this.next.hide();
      }
      else{
        if(this.name=="tutorial")
          this.next_t.show();
        else
          this.next.show();
      }
      this.pre_visible=this.parent.visible;
    }
    else if(!this.name.match("settings")&&this.name!="exit"){
      if(this.name!="entry"){
        if(!phina.isMobile()){
          
          if(keyboard.getKeyDown("up")){
            this.keyqueue.push("up");
          }
          else if(keyboard.getKeyDown("down")){
            this.keyqueue.push("down");
          }
          if(keyboard.getKeyDown("z")){
            this.keyqueue.push("z");
          }
          if(keyboard.getKeyDown("x")&&this.name!="root"){
            this.keyqueue.push("x");
          }
          var key;
          if(this.list.y===0){
            if(this.keyqueue.length>0){
              key = this.keyqueue[0];
              this.keyqueue.shift();
            }
            if(key=="up"){
              owner.cursorSE.play();
              this.up(y_offset);
            }
            else if(key=="down"){
              owner.cursorSE.play();
              this.down(y_offset);
            }
            else if(key=="z"){
              this.keyqueue=[];
              var ret = this.enter(owner);
              if(ret != null){
                return ret;
              }
            }
            else if(key=="x"){
              owner.cancelSE.play();
              this.resetorder();
              this.keyqueue=[];
              return this.parentname;
            }
          }
        }
        else{
          if(this.dummy.enterflag){
            this.dummy.enterflag=false;
            var ret = this.enter(owner);
            if(ret != null){
              return ret;
            }
          }
          else if(this.dummy.upflag){
            owner.cursorSE.play();
            this.dummy.upflag=false;
            this.up(y_offset);
          }
          else if(this.dummy.downflag){
            owner.cursorSE.play();
            this.dummy.downflag=false;
            this.down(y_offset);
          }
        }
        return this.name;
      }
      else{
        this.controlobj.mode="standby";
        this.controlobj.target.mode="standby";
        if(keyboard.getKeyDown("x")){
          owner.cancelSE.play();
          this.controlobj.mode="safe";
          this.controlobj.target.mode="safe";
          return this.parentname;
        }
        return this.name;
      }
    }
    else if(this.name.match("settings")){
      if(!this.pre_visible){
        this.board.tweener.clear().set({
          x:SCREEN_WIDTH/2,y:120,scaleX:0.1,scaleY:0.1
        }).to({
          x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/2,scaleX:1,scaleY:1
        },500,"easeOutQuart").call(function(){
          this.openflag=true;
        },this);
      }
      if(this.openflag){
        if(this.name == "game_settings"){
          if(this.controlobj.gn == 1){
            this.controlobj.deuce = false;
          }
          if(this.controlobj.deuce){
            this.on_d.show();
            this.off_d.hide();
          }
          else{
            this.on_d.hide();
            this.off_d.show();
          }
        }
        if(this.name == "sound_settings"){
          this.controlobj.se = this.segage.width/100;
          this.controlobj.SEpool.forEach(function(_se){
            _se.volume = 0.15*this.controlobj.se;
          },this);
          this.controlobj.bgm = this.bgmgage.width/100;
           this.controlobj.BGMpool.forEach(function(_bgm){
            _bgm.volume = 0.2*this.controlobj.bgm;
          },this);
        }
        if(!phina.isMobile()){
          if(keyboard.getKeyDown("up")){
            owner.cursorSE.play();
            this.Iterator = (this.Iterator-1<0) ?  this.objects.length-1:this.Iterator-1;
            if(this.name == "settings")
              this.cursor.x = -this.objects[this.Iterator].width/2-10;
            else if(this.Iterator == this.objects.length-1)
              this.cursor.x = -this.objects[this.Iterator].width/2-10;
            else
              this.cursor.x = this.objects[this.Iterator].x -10;
            this.cursor.y = this.objects[this.Iterator].y;
          }
          else if(keyboard.getKeyDown("down")){
            owner.cursorSE.play();
            this.Iterator = (this.Iterator+1>this.objects.length-1) ?  0 :this.Iterator+1;
            if(this.name == "settings")
              this.cursor.x = -this.objects[this.Iterator].width/2-10;
            else if(this.Iterator == this.objects.length-1)
              this.cursor.x = -this.objects[this.Iterator].width/2-10;
            else
              this.cursor.x = this.objects[this.Iterator].x -10;
            this.cursor.y = this.objects[this.Iterator].y;
          }
          if(keyboard.getKey("left")&&this.name=="sound_settings"){
            if(this.Iterator == 0){
              this.controlobj.se = (this.controlobj.se-0.01<0) ? 0 : this.controlobj.se-0.01;
              this.controlobj.SEpool.forEach(function(_se){
                _se.volume = 0.15*this.controlobj.se;
              },this);
              this.segage.width=100*this.controlobj.se;
            }
            else if(this.Iterator == 1){
              this.controlobj.bgm = (this.controlobj.bgm-0.01<0) ? 0 : this.controlobj.bgm-0.01;
              this.controlobj.BGMpool.forEach(function(_bgm){
                _bgm.volume = 0.2*this.controlobj.bgm;
              },this);
              this.bgmgage.width=100*this.controlobj.bgm;
            }
          }
          else if(keyboard.getKey("right")&&this.name=="sound_settings"){
            if(this.Iterator == 0){
              this.controlobj.se = (this.controlobj.se+0.01>1) ? 1 : this.controlobj.se+0.01;
              this.controlobj.SEpool.forEach(function(_se){
                _se.volume = 0.15*this.controlobj.se;
              },this);
              this.segage.width=100*this.controlobj.se;
            }
            else if(this.Iterator == 1){
              this.controlobj.bgm = (this.controlobj.bgm+0.01>1) ? 1 : this.controlobj.bgm+0.01;
              this.controlobj.BGMpool.forEach(function(_bgm){
                _bgm.volume = 0.2*this.controlobj.bgm;
              },this);
              this.bgmgage.width=100*this.controlobj.bgm;
            }
          }
          if(keyboard.getKeyDown("z")){
            var ret = this.enter(owner);
            return ret;
          }
          else if(keyboard.getKeyDown("x")){
            owner.cancelSE.play();
            this.Iterator=0;
            if(this.name == "settings")
              this.cursor.x = -this.objects[this.Iterator].width/2-10;
            else if(this.Iterator == this.objects.length-1)
              this.cursor.x = -this.objects[this.Iterator].width/2-10;
            else
              this.cursor.x = this.objects[this.Iterator].x -10;
            this.cursor.y = this.objects[this.Iterator].y;
            if(this.name=="settings"){
              this.openflag=false;
              this.pre_visible = false;
              this.board.x = -SCREEN_WIDTH;
              this.board.y = -SCREEN_HEIGHT;
            }
            return this.parentname;
          }
        }
        else{
          if(this.board.enterflag){
            this.board.enterflag=false;
            this.Iterator = this.board.Iterator;
            var ret = this.enter(owner);
            return ret;
          }
        }
      }
      this.pre_visible = this.parent.visible;
      return this.name;
    }
    else if(this.name ==="exit"){//this.name==exit
      if(!this.pre_visible){
        this.board.tweener.clear().set({
          x:SCREEN_WIDTH/2,y:120,scaleX:0.1,scaleY:0.1
        }).to({
          x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/2,scaleX:1,scaleY:1
        },500,"easeOutQuart").call(function(){
          this.openflag=true;
        },this);
      }
      if(this.openflag){
        if(!phina.isMobile()){
          if(keyboard.getKeyDown("left")){
            owner.cursorSE.play();
            this.Iterator = this.Iterator-1<0 ? this.objects.length-1 : this.Iterator-1;
            this.cursor.x = this.objects[this.Iterator].x -20;
            this.cursor.y = this.objects[this.Iterator].y;
          }
          else if(keyboard.getKeyDown("right")){
            owner.cursorSE.play();
            this.Iterator = this.Iterator+1>this.objects.length-1 ? 0 : this.Iterator+1;
            this.cursor.x = this.objects[this.Iterator].x -20;
            this.cursor.y = this.objects[this.Iterator].y;
          }
          if(keyboard.getKeyDown("z")){
            var ret = this.enter(owner);
            return ret;
          }
          else if(keyboard.getKeyDown("x")){
            owner.cancelSE.play();
            this.Iterator=1;
            this.cursor.x = this.objects[this.Iterator].x -20;
            this.cursor.y = this.objects[this.Iterator].y;
            this.openflag=false;
            this.pre_visible = false;
            this.board.x = -SCREEN_WIDTH;
            this.board.y = -SCREEN_HEIGHT;
            return this.parentname;
          }
        }
        else{
          if(this.board.enterflag){
            this.board.enterflag=false;
            this.Iterator = this.board.Iterator;
            var ret = this.enter(owner);
            return ret;
          }
        }
      }
      this.pre_visible = this.parent.visible;
      return this.name;
    }
    return this.name;
  },
  up: function(val){
    var y = 110;
    var y_offset = val;
    this.list.tweener.clear().to({
      y: y_offset,
    },200,"easeOutQuart").call(function(){
      var buffer=[];
      this.objects.forEach(function(obj,i){
        obj.y=0;
        if(i<this.objects.length-1)
          buffer[i+1]=obj;
        else{
          buffer[0]=obj;
        }
      },this);
      this.objects=buffer;
      this.objects[0].y=y;
      this.objects[1].y=y+y_offset;
      this.objects[2].y=y+y_offset*2;
      this.objects[this.objects.length-1].y=y-y_offset;
      this.objects[this.objects.length-2].y=y-y_offset*2;
      this.list.y=0;
    },this);
  },
  down: function(val){
    var y = 110;
    var y_offset = val;
    this.list.tweener.clear().to({
      y: -y_offset,
    },200,"easeOutQuart").call(function(){
      var buffer=[];
      this.objects.forEach(function(obj,i){
        obj.y=0;
        if(0<i)
          buffer[i-1]=obj;
        else{
          buffer[this.objects.length-1]=obj;
        }
      },this);
      this.objects=buffer;
      this.objects[0].y=y;
      this.objects[1].y=y+y_offset;
      this.objects[2].y=y+y_offset*2;
      this.objects[this.objects.length-1].y=y-y_offset;
      this.objects[this.objects.length-2].y=y-y_offset*2;
      this.list.y=0;
    },this);
  },
  enter: function(owner){
    switch(this.name){
      case "root": 
        switch(this.objects[0].name){
          case "color":
            owner.cursorSE.play();
            if(this.controlobj.object.name.match("yukari"))
              return "color_y";
            else if(this.controlobj.object.name.match("maki"))
              return "color_m";
            break;
          case "entry":
            owner.enterSE.play();
            return "entry";
          default:
            owner.cursorSE.play();
            return this.objects[0].name;
        }
        break;
      case "color_y":
        switch(this.objects[0].name){
          case "back":
            owner.cancelSE.play();
            this.resetorder();
            return this.parentname;
          default:
            var chara="yukari";
            var objname=chara+"_"+this.objects[0].name;
            if(this.controlobj.target.object.name!=objname&&this.controlobj.object.name!=objname){
              owner.cursorSE.play();
              this.controlobj.statusupdate();
              var tmpx=this.controlobj.object.x,tmpy=this.controlobj.object.y;
              var objssname=objname+"_ss";
              if(objname!="yukari_legacy"){
                objssname = "yukari_origin_ss";
              }
              this.controlobj.object_ss.remove();
              this.controlobj.object.remove();
              this.controlobj.object=Sprite(objname).addChildTo(owner.fighters);
              this.controlobj.object.setPosition(tmpx,tmpy);
              this.controlobj.object.origin.set(0,0);
              this.controlobj.object.frameIndex=0;
              this.controlobj.object_ss = FrameAnimation(objssname);
              this.controlobj.object_ss.attachTo(this.controlobj.object);
              this.controlobj.object_ss.gotoAndPlay(this.controlobj.status);
              this.controlobj.object_ss.currentFrameIndex=this.controlobj.frame;
            }
            break;
        }
        break;
      case "color_m":
        switch(this.objects[0].name){
          case "back":
            owner.cancelSE.play();
            this.resetorder();
            return this.parentname;
          default:
            var chara="maki";
            var objname=chara+"_"+this.objects[0].name;
            if(this.controlobj.target.object.name!=objname&&this.controlobj.object.name!=objname){
              owner.cursorSE.play();
              this.controlobj.statusupdate();
              var tmpx=this.controlobj.object.x,tmpy=this.controlobj.object.y;
              var chara="maki";
              var objname=chara+"_"+this.objects[0].name;
              var objssname="maki_origin_ss";
              this.controlobj.object_ss.remove();
              this.controlobj.object.remove();
              this.controlobj.object=Sprite(objname).addChildTo(owner.fighters);
              this.controlobj.object.setPosition(tmpx,tmpy);
              this.controlobj.object.origin.set(0,0);
              this.controlobj.object.frameIndex=0;
              this.controlobj.object_ss = FrameAnimation(objssname);
              this.controlobj.object_ss.attachTo(this.controlobj.object);
              this.controlobj.object_ss.gotoAndPlay(this.controlobj.status);
              this.controlobj.object_ss.currentFrameIndex=this.controlobj.frame;
            }
            break;
        }
        break;
      case "charactor":
        switch(this.objects[0].name){
          case "back":
            owner.cancelSE.play();
            this.resetorder();
            return this.parentname;
          default:
            var chara = this.objects[0].name.split("_")[1];
            if(!this.controlobj.object.name.match(chara)){
              owner.cursorSE.play();
              this.controlobj.statusupdate();
              var tmpx=this.controlobj.object.x,tmpy=this.controlobj.object.y;
              var objname = chara + "_origin";
              if(this.controlobj.target.object.name==objname)
                objname = chara + "_white";
              var objssname = chara+"_origin_ss";
              this.controlobj.object_ss.remove();
              this.controlobj.object.remove();
              this.controlobj.object=Sprite(objname).addChildTo(owner.fighters);
              this.controlobj.object.setPosition(tmpx,tmpy);
              this.controlobj.object.origin.set(0,0);
              this.controlobj.object.frameIndex=0;
              this.controlobj.object_ss = FrameAnimation(objssname);
              this.controlobj.object_ss.attachTo(this.controlobj.object);
              this.controlobj.object_ss.gotoAndPlay(this.controlobj.status);
              this.controlobj.object_ss.currentFrameIndex=this.controlobj.frame;
            }
            break;
        }
        break;
      case "settings":
        switch(this.objects[this.Iterator].name){
          case "back_s":
            owner.cancelSE.play();
            this.openflag=false;
            this.pre_visible = false;
            this.board.x = -SCREEN_WIDTH;
            this.board.y = -SCREEN_HEIGHT;
            this.Iterator=0;
            if(!phina.isMobile()){
              this.cursor.x = -this.objects[this.Iterator].width/2-10;
              this.cursor.y = this.objects[this.Iterator].y;
            }
            return this.parentname;
          default:
            owner.cursorSE.play();
            return this.objects[this.Iterator].name;
        }
        break;
      case "game_settings":
        switch(this.objects[this.Iterator].name){
          case "back_s":
            owner.cancelSE.play();
            this.Iterator=0;
            if(!phina.isMobile()){
              this.cursor.x = this.objects[this.Iterator].x -10;
              this.cursor.y = this.objects[this.Iterator].y;
            }
            return this.parentname;
          case "game_num":
            owner.cursorSE.play();
            owner.gn = (owner.gn + 1) > 5 ? 1 : owner.gn + 1;
            this.gns.forEach(function(gn){
              gn.hide();
            });
            this.gns[owner.gn-1].show();
            return this.name;
          case "deuce":
            owner.cursorSE.play();
            if(owner.gn != 1){
              if(owner.deuce)
                owner.deuce=false;
              else
                owner.deuce=true;
              if(owner.deuce){
                this.on_d.show();
                this.off_d.hide();
              }
              else{
                this.on_d.hide();
                this.off_d.show();
              }
            }
            return this.name;
          case "cpu_vs_cpu":
            owner.cursorSE.play();
            if(owner.cpu_vs_cpu)
              owner.cpu_vs_cpu=false;
            else
              owner.cpu_vs_cpu=true;
            if(owner.cpu_vs_cpu){
              this.on_cvc.show();
              this.off_cvc.hide();
            }
            else{
              this.on_cvc.hide();
              this.off_cvc.show();
            }
            return this.name;
        }
        break;
      case "sound_settings":
        switch(this.objects[this.Iterator].name){
          case "back_s":
            owner.cancelSE.play();
            this.Iterator=0;
            if(!phina.isMobile()){
              this.cursor.x = this.objects[this.Iterator].x -10;
              this.cursor.y = this.objects[this.Iterator].y;
            }
            return this.parentname;
          case "bgm":
            var satiflag=false;
            if(owner.bgm==1)
              satiflag=true;
            owner.bgm = (owner.bgm + 0.1) > 1 ? 1 : owner.bgm + 0.1;
            owner.BGMpool.forEach(function(bgm){
              bgm.volume = 0.2*owner.bgm;
            });
            this.bgmgage.width = owner.bgm*100;
            if(!satiflag)
              owner.cursorSE.play();
            return this.name;
          case "se":
            var satiflag=false;
            if(owner.se==1)
              satiflag=true;
            owner.se = (owner.se + 0.1) > 1 ? 1 : owner.se + 0.1;
            owner.SEpool.forEach(function(se){
              se.volume = 0.15*owner.se;
            });
            if(!satiflag)
              owner.cursorSE.play();
            this.segage.width = owner.se*100;
            return this.name;
        }
        break;
      case "exit":
        switch(this.objects[this.Iterator].name){
          case "yes":
            owner.cursorSE.play();
            owner.lobbyBGM.stop();
            owner.exit(owner.params);
            return this.name;
          case "no":
            owner.cancelSE.play();
            this.Iterator=1;
            if(!phina.isMobile()){
              this.cursor.x = this.objects[this.Iterator].x -20;
              this.cursor.y = this.objects[this.Iterator].y;
            }
            this.openflag=false;
            this.pre_visible = false;
            this.board.x = -SCREEN_WIDTH;
            this.board.y = -SCREEN_HEIGHT;
            return this.parentname;
        }
        break;
    }
    return this.name;
  },
  resetorder: function(){
    var y = 110;
    var y_offset = 12;
    var cycle = function(i,owner){
      i.times(function(j){
        var buffer=[];
        this.objects.forEach(function(obj,i){
          obj.y=0;
          if(0<i)
            buffer[i-1]=obj;
          else{
            buffer[this.objects.length-1]=obj;
          }
        },this);
        this.objects=buffer;
        this.objects[0].y=y;
        this.objects[1].y=y+y_offset;
        this.objects[2].y=y+y_offset*2;
        this.objects[this.objects.length-1].y=y-y_offset;
        this.objects[this.objects.length-2].y=y-y_offset*2;
      },owner);
    };
    //var buffer = this.objects.concat();
    var diff=0;
    this.objects.some(function(obj,i){
      if(this.elements[0]==obj.name){
        diff=i;
        return true;
      }
    },this);
    if(diff!=0){
      cycle(diff,this);
    }
  }
});
phina.define("GameObject",{
  init: function(images,spritesheet,owner,x,y,isenemy){
    this.object=Sprite(images[0]).addChildTo(owner);
    (images.length-1).times(function(i){
      this.object.addImage(images[i+1]);
    },this);
    this.object.setPosition(x,y);
    this.object.origin.set(0,0);
    this.object.frameIndex=0;
    this.object_ss = FrameAnimation(spritesheet);
    this.object_ss.attachTo(this.object);
    this.object_ss.gotoAndPlay("idol");
    
    this.target=null;
    
    this.hitpoint = 10;
    
    this.roundpoint=0;
    
    this.match = false;
    
    this.x_tmp=0;
    this.y_tmp=0;
    this.now=0;
    this.start=0;
    this.status = this.object_ss.currentAnimation.self;
    this.pre_status = this.status;
    this.frame = this.object_ss.currentFrameIndex;
    this.direction = "right";
    
    this.counter_df1_r=0;
    this.counter_df1_l=0;
    this.counter_df2_r=0;
    this.counter_df2_l=0;
    this.df1_r=false;
    this.df1_l=false;
    this.df2_r=false;
    this.df2_l=false;
    this.df3_r=false;
    this.df3_l=false;
    this.counter_hold=0;
    this.jslash_count=0;
    this.towinpose=false;
    this.input = GameInput();
    if(!isenemy)
      this.inputable=true;
    else
      this.inputable=false;
    this.s_shiftflag=false;
    this.isenemy=isenemy;
    this.sousai=false;
    this.hitflag=false;
    
    this.mode="safe";
    this.cattack=false;
    this.sit=false;
    this.okizeme=false;
    this.hangeki=false;
    this.demo=true;
    this.winposecounter=0;
    this.sitcounter=0;
    this.cattackcounter=0;
    this.attackable=true;
    this.idolfromwinflag=false;
    this.sflag=false;
    
    this.fallcounter=0;
  },
  update: function(pointer,pointers,keyboard,owner){
    
    
    
    this.statusupdate();//アニメーション完了による状態変更を適用
    
    if(this.status!=="damage"&&this.status!=="jdamage"&&this.status!=="sdamage"&&this.status!=="counterdamage"
    &&this.status!=="jump"&&this.status!=="jslash"&&this.status!=="dash"&&this.status!=="slash"
    &&this.status!=="jrslash"&&this.status!="jdamage_keep"&&this.status!="shirimochi"&&!this.df3_l&&!this.df3_r){
      if(this.object.x < this.target.object.x)
        this.direction="right";
      else
        this.direction="left";
    }
    if(this.status==="jump"&&this.pre_status==="jslash"&&!this.s_shiftflag){
      this.s_shiftflag=true;
      this.object_ss.currentFrameIndex=this.counter_hold;
      this.statusupdate();
    }
    if(this.status==="idol"&&this.pre_status==="jump"){
      this.jslash_count=0;
    }
    if(this.status==="idol"&&this.towinpose){
      this.towinpose=false;
      this.object_ss.gotoAndPlay("winpose");
      this.statusupdate();
    }
    if(this.status ==="down"&&this.pre_status=="shirimochi"&&this.frame==0&&this.hitpoint==0){
      this.object_ss.gotoAndPlay("dead");
      this.statusupdate();
    }
    if(this.status == "jdamage_keep"&&this.pre_status=="jdamage"&&!this.s_shiftflag){
      this.s_shiftflag=true;
      this.hitflag=false;
      this.sousai=false;
      var tmp = this.counter_hold;
      if(tmp -1 < 10){
        tmp=10+10-(tmp-1)+1;
      }
      //console.log(tmp);
      this.object_ss.currentFrameIndex=tmp;
      this.statusupdate();
    }
    if(this.status==="idol"&&this.pre_status==="damage"){
      this.hitflag=false;
      this.sousai=false;
    }
    if(this.status==="idol"&&this.pre_status==="slash"){
      this.hitflag=false;
      this.sousai=false;
    }
    if(this.status==="idol"&&this.pre_status==="sslash"){
      this.hitflag=false;
      this.sousai=false;
    }
    if(this.status==="jump"&&this.pre_status==="jslash"){
      this.hitflag=false;
      this.sousai=false;
    }
    if(this.status==="idol"&&this.pre_status==="jrslash"){
      this.hitflag=false;
      this.sousai=false;
    }
    if(this.status=="idol"&&this.pre_status=="wintoidol"&&!this.sflag){
      this.sflag=true;
      this.idolfromwinflag=true;
    }
    else{
      this.idolfromwinflag=false;
    }
    //入力
    if(this.inputable){
      var p = pointer;
      var ps = pointers;
      var touches = [];
      if(phina.isMobile()){
        ps.forEach(function(_p, i){
          // 今タッチ中のものだけを touches に入れる
          if(!_p.getPointingEnd() && _p.getPointing()){
            touches.push(_p);
          }
        });
        
        if(touches.length>=1){
          this.now=true;
          if(touches.length==1)
            this.start=p.getPointingStart();
        }
        else{
          this.now=false;
        }
        if(touches.length==2){
          this.input.a=true;
        }
        else{
          this.input.a=false;
        }
        if(this.start){
          this.x_tmp=p.x;
          this.y_tmp=p.y;
        }
        if (this.now) {
          var diff_x = this.x_tmp - p.x;
          var diff_y = this.y_tmp - p.y;
          if (Math.abs(diff_x) > SPEED*5/FOUR) {
            if (diff_x < 0) {
              this.input.right=true;
            }
            else {
              this.input.left=true;
            }
          }
          if(diff_y > SPEED*5/FOUR){
            this.input.up=true;
          }
          if(diff_y < -SPEED*5/FOUR){
            this.input.down=true;
          }
          if(Math.abs(diff_x)<=SPEED*5/FOUR){
            this.input.right=false;
            this.input.left=false;
          }
          if(Math.abs(diff_y)<=SPEED*5/FOUR){
            this.input.up=false;
            this.input.down=false;
          }
        }
        else {
          this.input.up=false;
          this.input.down=false;
          this.input.left=false;
          this.input.right=false;
        }
      }
      else{
        this.input.left=keyboard.getKey("left");
        this.input.right=keyboard.getKey("right");
        this.input.up=keyboard.getKey("up");
        this.input.down=keyboard.getKey("down");
        this.input.a=keyboard.getKey("z");
        
      }
      if(this.input.left&&this.input.right){
        this.input.left=false;
        this.input.right=false;
      }
      if(this.input.up&&this.input.down){
        this.input.up=false;
        this.input.down=false;
      }
    }
    else{
      this.input.a=false;
      this.input.b=false;
      this.input.up=false;
      this.input.down=false;
      this.input.left=false;
      this.input.right=false;
      
      if(this.mode=="sslash"){
        this.input.down=true;
        this.input.a=true;
      }
      if(this.mode!="standby"){
        if(this.status=="winpose_keep"){
          this.winposecounter++;
          if(this.winposecounter>=30){
            this.winposecounter=0;
            this.object_ss.gotoAndPlay("wintoidol");
            this.statusupdate();
          }
        }
        if(this.status=="damage"){
          this.mode="wait";
        }
        if(this.target.status=="counterdamage"){
          this.mode="wait";
          this.hangeki=true;
        }
        if(this.target.status=="jdamage"){
          this.mode="wait";
          this.okizeme=true;
        }
        if(this.mode=="wait"){
          if(this.status=="idol"){
            this.mode="safe";
            if(this.okizeme){
              this.mode="okizeme";
              this.okizeme=false;
            }
            if(this.hangeki){
              this.mode="hangeki";
              this.hangeki=false;
            }
          }
          if(this.status=="sit"){
            this.sit=false;
          }
        }
        if(this.mode=="safe"){
          if(this.sit){
            this.sitcounter++;
            this.input.down=true;
            var tmp = Math.random();
            if(tmp<0.2){
              this.mode="combo";
            }
            if(this.sitcounter>7){
              this.input.down=false;
              this.sitcounter=0;
              this.sit=false;
            }
          }
          else{
            if(Math.abs(this.object.x-this.target.object.x)<410/FOUR&&!this.cattack){
              if(this.status==="jump"){
                if(Math.abs(this.object.x-this.target.object.x)<285/FOUR&&this.target.status!="sit"&&this.target.status!="sslash")
                  this.input.a=true;
              }
              if(this.target.status=="sslash"){
              this.input.up=true;
              this.input.a=true;
              }
              if(this.target.status=="slash"){
                this.sit=true;
                this.input.down=true;
                this.sitcounter=0;
              }
              if(this.target.status=="dash"){
                var tmp=Math.random();
                if(tmp<0.5){
                  this.input.a=true;
                }
                else{
                  this.input.down=true;
                  this.sit=true;
                  this.mode="combo";
                }
              }
              else if(this.target.status=="jump"){
                this.input.a=true;
              }
              else{
                if(this.target.object.x<this.object.x)
                  this.input.right=true;
                else
                  this.input.left=true;
              }
            }
            if(Math.abs(this.object.x-this.target.object.x)>=410/FOUR&&Math.abs(this.object.x-this.target.object.x)<410/FOUR+48/FOUR&&this.target.status=="slash"){
              this.cattack=true;
            }
            if(this.cattack){
              this.cattackcounter++;
              if(this.cattackcounter>5){
                this.cattackcounter=0;
                this.cattack=false;
                this.input.a=true;
              }
            }
            if(this.target.status=="damage"){
              this.mode="combo";
            }
            if(410/FOUR<=Math.abs(this.object.x-this.target.object.x)&&Math.abs(this.object.x-this.target.object.x)<460/FOUR){
              if(this.target.object.x<this.object.x)
                this.input.right=true;
              else
                this.input.left=true;
            }
            if(460/FOUR<=Math.abs(this.object.x-this.target.object.x)&&Math.abs(this.object.x-this.target.object.x)<500/FOUR){
              var tmp=Math.random();
              if(tmp<0.2)
                this.input.a=true;
            }
            if(500/FOUR<=Math.abs(this.object.x-this.target.object.x)){
              var tmp=Math.random();
              if(tmp<0.01){
                this.input.a=true;
              }
              else{
                if(this.target.object.x<this.object.x)
                  this.input.left=true;
                else
                  this.input.right=true;
              }
            }
          }
        }
        if(this.mode=="combo"){
          if(this.status=="jump"){
            this.input.a=true;
          }
          if(this.status=="idol"){
            var tmp = Math.random();
            if(tmp < 1/3){
              this.input.a=true;
            }
            else if(tmp < 2/3){
              this.sit=true;
              this.input.down=true;
            }
            else{
              this.input.up=true;
              this.input.a=true;
            }
          }
          if(this.sit){
            this.input.down=true;
            if(this.status=="sit"){
              this.sit=false;
              this.input.a=true;
              this.mode="wait";
            }
          }
        }
        if(this.mode=="okizeme"){
          if(Math.abs(this.object.x-this.target.object.x)>=400/FOUR){
            if(this.target.object.x<this.object.x){
              if(this.status=="idol"){
                this.object_ss.gotoAndPlay("dash");
                this.statusupdate();
              }
              this.input.left=true;
            }
            else{
              if(this.status=="idol"){
                this.object_ss.gotoAndPlay("dash");
                this.statusupdate();
              }
              this.input.right=true;
            }
          }
          else{
            this.input.a=true;
            this.mode="wait";
          }
        }
        if(this.mode=="hangeki"){
          if(this.target.status!="counterdamage"){
            this.mode="safe";
          }
          if(Math.abs(this.object.x-this.target.object.x)<250/FOUR){
            if(this.target.object.x<this.object.x)
                this.input.right=true;
              else
                this.input.left=true;
          }
          else{
            this.input.a=true;
            if(this.target.status==="damage"){
              this.mode="combo";
            }
          }
        }
      }
      else{
        this.input.down=false;
        this.input.up=false;
        if(this.isenemy){
          if(this.object.x>=310/FOUR){
            this.input.left=true;
          }
          if(this.object.x<300/FOUR){
            this.input.right=true;
          }
        }
        else{
          if(this.object.x<=-310/FOUR){
            this.input.right=true;
          }
          if(this.object.x>-300/FOUR){
            this.input.left=true;
          }
        }
      }
    }
    if(!this.attackable){
      this.input.a=false;
    }
    
    
    //入力から状態を決定
    if(!this.input.left){
      if(this.df3_l)
        this.df3_l=false;
      
			if(this.df1_l&&!this.df2_l&& this.counter_df1_l < 6){
				this.df1_l=false;
				this.df2_l=true;
				this.counter_df1_l = 0;
			}
			else if(this.df1_l&&6<=this.counter_df1_l){
				this.df1_l=false;
				this.df2_l=false;
				this.counter_df1_l = 0;
			}
      if(this.direction=="left"&&(this.status==="walkbegin"||this.status==="walk"||this.status==="dash")){
        if(this.status==="dash"){
          this.counter_df2_l=0;
          this.df2_l=false;
        }
        this.object_ss.gotoAndPlay("idol");
        this.statusupdate();
      }
      else if(this.direction=="right"&&(this.status==="backwalkbegin"||this.status==="backwalk")){
        this.object_ss.gotoAndPlay("idol");
        this.statusupdate();
      }
    }
    if(!this.input.right){
      if(this.df3_r)
        this.df3_r=false;
      if(this.df1_r&&!this.df2_r&& this.counter_df1_r < 6){
				this.df1_r=false;
				this.df2_r=true;
				this.counter_df1_r = 0;
			}
			else if(this.df1_r&&6<=this.counter_df1_r){
				this.df1_r=false;
				this.df2_r=false;
				this.counter_df1_r = 0;
			}
			if(this.direction=="right"&&(this.status==="walkbegin"||this.status==="walk"||this.status==="dash")){
        if(this.status==="dash"){
          this.counter_df2_r=0;
          this.df2_r=false;
        }
        this.object_ss.gotoAndPlay("idol");
        this.statusupdate();
      }
      else if(this.direction=="left"&&(this.status==="backwalkbegin"||this.status==="backwalk")){
        this.object_ss.gotoAndPlay("idol");
        this.statusupdate();
      }
    }
    if(!this.input.down){
      if(this.status==="sit"){
          this.object_ss.gotoAndPlay("standup");
          this.statusupdate();
        }
    }
    if(this.input.left){
      if(this.df3_l){
        this.df3_l=false;
        if(this.status==="idol"){
          this.object_ss.gotoAndPlay("dash");
          this.statusupdate();
        }
      }
      this.df1_l=true;
      if(this.df2_l&& this.counter_df2_l <6){
				this.df2_l = false;
				this.counter_df2_l = 0;
				if(this.status === "idol"||this.status == "walk"||this.status == "walkbegin"){
					if(this.direction ==="left"){
						this.object_ss.gotoAndPlay("dash");
            this.statusupdate();
					}
					else{
						this.object_ss.gotoAndPlay("backstep");
            this.statusupdate();
					}
				}
			}
			else if(this.df2_l){
			  this.df2_l = false;
				this.counter_df2_l = 0;
			}
      if(this.direction=="left"){
        if(this.status==="idol"||this.status==="backwalk"||this.status==="backwalkbegin"){
          this.object_ss.gotoAndPlay("walkbegin");
          this.statusupdate();
        }
      }
      else{
        if(this.status==="idol"||this.status==="walk"||this.status==="walkbegin"){
          this.object_ss.gotoAndPlay("backwalkbegin");
          this.statusupdate();
        }
      }
    }
    if(this.input.right){
      if(this.df3_r){
        this.df3_r=false;
        if(this.status==="idol"){
          this.object_ss.gotoAndPlay("dash");
          this.statusupdate();
        }
      }
      this.df1_r=true;
      if(this.df2_r&& this.counter_df2_r <6){
				this.df2_r = false;
				this.counter_df2_r = 0;
				if(this.status === "idol"||this.status == "walk"||this.status == "walkbegin"){
					if(this.direction ==="right"){
						this.object_ss.gotoAndPlay("dash");
            this.statusupdate();
					}
					else{
						this.object_ss.gotoAndPlay("backstep");
            this.statusupdate();
					}
				}
			}
			else if(this.df2_r){
			  this.df2_r = false;
				this.counter_df2_r = 0;
			}
      if(this.direction=="right"){
        if(this.status==="idol"||this.status==="backwalk"||this.status==="backwalkbegin"){
          this.object_ss.gotoAndPlay("walkbegin");
          this.statusupdate();
        }
      }
      else{
        if(this.status==="idol"||this.status==="walk"||this.status==="walkbegin"){
         this.object_ss.gotoAndPlay("backwalkbegin");
         this.statusupdate();
        }
      }
    }
    if(this.input.up){
      if(this.status==="idol"||this.status==="backwalkbegin"||this.status==="backwalk"||this.status==="walkbegin"||this.status==="walk"||this.status==="dash"){
          this.object_ss.gotoAndPlay("jump");
          this.statusupdate();
          if(this.pre_status==="dash"){
            this.object_ss.currentFrameIndex=2;
            this.statusupdate();
          }
        }
    }
    if(this.input.down){
      if(this.status==="idol"||this.status==="backwalkbegin"||this.status==="backwalk"||this.status==="walkbegin"||this.status==="walk"){
        this.object_ss.gotoAndPlay("sitdown");
        this.statusupdate();
      }
      else if(this.status==="dash"){
        this.object_ss.gotoAndPlay("sit");
        this.statusupdate();
      }
    }
    if(this.input.a){
      //console.log("attack");
      if(this.status==="idol"||this.status==="walk"||this.status==="walkbegin"||this.status==="backwalk"||this.status==="backwalkbegin"){
        this.object_ss.gotoAndPlay("slash");
        this.statusupdate();
      }
      if(this.status==="dash"){
        this.object_ss.gotoAndPlay("slash");
        this.statusupdate();
      }
      if(this.status=="jump"&&this.frame<=2){
        this.object_ss.gotoAndPlay("jrslash");
        this.statusupdate();
      }
      if(this.status==="jump"&&2<this.frame&&this.frame<18&&this.jslash_count<3){
        this.jslash_count++;
        this.counter_hold=this.frame;
        this.object_ss.gotoAndPlay("jslash");
        this.statusupdate();
        this.s_shiftflag=false;
      }
      if(this.status=="sit"){
        this.object_ss.gotoAndPlay("sslash");
        this.statusupdate();
      }
    }
    //状態から動作を決定
    if(this.status==="walkbegin"||this.status==="walk"){
     if(this.direction=="right"){
      this.object.x += SPEED/FOUR;
     }
     else{
       this.object.x -= SPEED/FOUR;
     }
    }
    if(this.status==="backwalkbegin"||this.status==="backwalk"){
      if(this.direction=="right"){
      this.object.x -= SPEED/FOUR;
     }
     else{
       this.object.x += SPEED/FOUR;
     }
    }
    if(this.status==="dash"){
      if(this.direction==="right"){
        this.object.x += 19/FOUR;
      }
      else{
        this.object.x -= 19/FOUR;
      }
    }
    if(this.status==="backstep"){
      if(1<this.frame&&this.frame<14){
        if(this.direction==="right"){
          this.object.x -= 20/FOUR;
        }
        else{
          this.object.x += 20/FOUR;
        }
      }
    }
    if(this.status==="slash"){
      if(4<this.frame&&this.frame<8){
        if(this.direction=="right"){
          this.object.x += 16/FOUR;
         }
         else{
           this.object.x -= 16/FOUR;
         }
      }
    }
    if(this.status==="jump"){
      if(this.pre_status==="dash"&&!this.df3_r&&!this.df3_l){
        if(this.direction==="right"){
          this.df3_r=true;
        }
        else{
          this.df3_l=true;
        }
      }
      if(2<this.frame&&this.frame<18){
        var JUMP_Y_ = 2.5*Math.pow(this.frame-9.5,2)-106;
        var JUMP_DY_ = JUMP_Y_-(2.5*Math.pow(this.frame-1-9.5,2)-106);
        this.object.y += JUMP_DY_/FOUR;
      }
      if(this.pre_status==="walk"||this.pre_status==="walkbegin"){
        if(this.direction=="right"){
          this.object.x += SPEED/FOUR;
        }
        else{
          this.object.x -= SPEED/FOUR;
        }
      }
      if(this.pre_status==="backwalk"||this.pre_status==="backwalkbegin"){
        if(this.direction=="right"){
          this.object.x -= SPEED/FOUR;
         }
         else{
           this.object.x += SPEED/FOUR;
         }
      }
      if(this.pre_status==="dash"){
        if(this.direction=="right"){
          this.object.x += 19/FOUR;
        }
        else{
          this.object.x -= 19/FOUR;
        }
      }
      
    }
    if(this.status==="jrslash"){
      if(this.frame<15){
        var jump_y = 2.5*Math.pow(this.frame+3-9.5,2)-106;
        var jump_dy = jump_y-(2.5*Math.pow(this.frame+3-1-9.5,2)-106);
        this.object.y += jump_dy/FOUR;
      }
      if(this.direction=="right"){
        this.object.x += SPEED*3/FOUR;
      }
      else{
        this.object.x -= SPEED*3/FOUR;
      }
    }
    if(this.status==="jdamage"){
      if(this.direction=="right"){
        this.object.x -= SPEED*3/FOUR;
      }
      else{
        this.object.x += SPEED*3/FOUR;
      }
    }
    if(this.status==="jdamage_keep"){
      if(this.direction=="right"){
        this.object.x -= SPEED*3/FOUR;
      }
      else{
        this.object.x += SPEED*3/FOUR;
      }
      var jump_y = 2.5*Math.pow(this.frame-9.5,2)-106;
      var jump_dy = jump_y-(2.5*Math.pow(this.frame-1-9.5,2)-106);
      this.object.y += jump_dy/FOUR;
      if(this.object.y>=0){
        this.fallcounter=0;
        this.object.y=0;
        this.object_ss.gotoAndPlay("shirimochi");
        this.statusupdate();
      }
      else if(this.fallcounter >= 22){
        this.fallcounter=0;
        this.object.y=0;
        this.object_ss.gotoAndPlay("shirimochi");
        this.statusupdate();
      }
    }
    if(this.status==="shirimochi"){
      if(this.direction=="right"){
        this.object.x -= SPEED*3/FOUR;
      }
      else{
        this.object.x += SPEED*3/FOUR;
      }
    }
    if(this.direction=="right"){
      this.object.reverse=true;
    }
    else{
      this.object.reverse=false;
    }
    
    if(this.status == "jdamage_keep"){
      this.fallcounter++;
    }
    
    if(this.df1_l)
      this.counter_df1_l++;
    if(this.df1_r)
      this.counter_df1_r++;
    if(this.df2_l)
      this.counter_df2_l++;
    if(this.df2_r)
      this.counter_df2_r++;
  },
  updatehantei: function(hanteilist,hanteipool){
    var str = this.status;
    var i = 0;
    switch (str) {
      case 'backstep':
        i=0;
        break;
      case 'backwalk':
        i=1;
        break;
      case 'counterdamage':
        i=2;
        break;
      case 'damage':
        i=3;
        break;
      case 'dash':
        i=4;
        break;
      case 'down':
        i=5;
        break;
      case 'idol':
        i=6;
        break;
      case 'jdamage':
        i=7;
        break;
      case 'jrslash':
        i=8;
        break;
      case 'jslash':
        i=9;
        break;
      case 'jump':
        i=10;
        break;
      case 'sdamage':
        i=11;
        break;
      case 'shirimochi':
        i=12;
        break;
      case 'sit':
        i=13;
        break;
      case 'slash':
        i=14;
        break;
      case 'sslash':
        i=15;
        break;
      case 'wakeup':
        i=16;
        break;
      case 'walk':
        i=17;
        break;
      case 'winpose':
        i=18;
        break;
      case 'wintoidol':
        i=19;
        break;
      case 'backwalkbegin':
        i=20;
        break;
      case 'walkbegin':
        i=21;
        break;
      case 'standup':
        i=22;
        break;
      case 'sitdown':
        i=23;
        break;
      case 'jdamage_keep':
        i=24;
        break;
      default:
        i=5;
    }
    var frame = this.frame;
    if(str == "winpose"|| str=="wintoidol"){
      frame = 0;
    }
    if(str=="jdamage_keep"){
      frame = 20;
    }
    if(hanteilist[i][frame]==null){
      console.log(i,this.status,frame);
    }
    (hanteilist[i][frame].hantei.length).times(function(j){
      var h = new Object();
      h.type = hanteilist[i][frame].hantei[j].type;
      h.x1 = hanteilist[i][frame].hantei[j].x1/FOUR;
      h.y1 = hanteilist[i][frame].hantei[j].y1/FOUR;
      h.x2 = hanteilist[i][frame].hantei[j].x2/FOUR;
      h.y2 = hanteilist[i][frame].hantei[j].y2/FOUR;
      
      if(this.direction=="right"){
        var tmp = h.x1;
  			h.x1 = SCREEN_WIDTH/2-(h.x2-SCREEN_WIDTH/2);
  			h.x2 = SCREEN_WIDTH/2-(tmp-SCREEN_WIDTH/2);
  			
      }
      if(this.isenemy){
        if(h.type==="body"){
          h.type="body_e";
        }
        if(h.type==="attack"){
          h.type="attack_e";
        }
      }
      else{
        if(h.type==="body"){
          h.type="body_p";
        }
        if(h.type==="attack"){
          h.type="attack_p";
        }
      }
      h.x1 += this.object.x;
      h.x2 += this.object.x;
      h.y1 += this.object.y;
      h.y2 += this.object.y;
      hanteipool.push(h);
    },this);
    
  },
  statusupdate: function(){
      var tmp=this.pre_status;
      this.pre_status = this.status;
      this.status = this.object_ss.currentAnimation.self;
      if(this.pre_status===this.status){
        this.pre_status=tmp;
      }
      this.frame = this.object_ss.currentFrameIndex;
      //console.log(owner.pre_status,owner.status);
    },
  damage: function(owner){
    
    if(this.hitpoint != 0){
      if(this.status!="jdamage"||this.status!="jdamage_keep"){
        if(this.status==="jump"||this.status==="jslash"||this.status==="jrslash"){
          if(this.status==="jump"||this.status==="jrslash"){
            this.s_shiftflag=false;
            this.counter_hold=this.frame;
            if(this.status==="jrslash"){
              this.counter_hold+=3;
            }
          }
          if(this.object.x < this.target.object.x)
            this.direction="right";
          else
            this.direction="left";
          this.object_ss.gotoAndPlay("jdamage");
          this.statusupdate();
          if(!this.sousai)
            owner.jhitSE.play();
        }
        else if(this.status==="sit"){
          this.object_ss.gotoAndPlay("sdamage");
          this.statusupdate();
          if(!this.sousai)
            owner.slashSE.play();
        }
        else if(this.status==="slash"&&this.target.status==="sslash"){
          this.object_ss.gotoAndPlay("counterdamage");
          this.statusupdate();
          if(!this.sousai)
            owner.chitSE.play();
        }
        else if(this.status==="sslash"&&this.target.status==="jrslash"){
          this.object_ss.gotoAndPlay("counterdamage");
          this.statusupdate();
          if(!this.sousai)
            owner.chitSE.play();
        }
        else{
          this.object_ss.gotoAndPlay("damage");
          this.statusupdate();
          if(!this.sousai)
            owner.slashSE.play();
        }
      }
    }
    else{
      this.s_shiftflag=false;
      if(this.object.x < this.target.object.x)
        this.direction="right";
      else
        this.direction="left";
      this.object_ss.gotoAndPlay("jdamage");
      this.statusupdate();
      owner.todomeSE.play();
    }
  //console.log(this.status);
  }
});
/*
 * メインシーン
 */
phina.define("MainScene", {
  // 継承
  superClass: 'DisplayScene',

  // 初期化
  init: function(options) {
    // super init
    this.superInit(options);

    this.params={entries:[],win:0,lose:0,deuce:0,lastchara:"yukari"};
    this.rounds=[];
    /*var hit = 4;
    var damage =10;
    var scores =[];
    var score = {text:"hit",point:hit};
    scores.push(score);
    score = {text:"yourHP",point:damage};
    scores.push(score);
    score = {text:"by a hair",point:1};
    scores.push(score);
    var round = {scores:scores};
    this.rounds.push(round);
    this.rounds.push(round);
    this.rounds.push(round);
    this.rounds.push(round);
    var entry = {rounds: this.rounds};
    this.params.entries.push(entry);
    this.rounds=[];*/
    
    this.gn = 2;
    this.deuce = false;
    this.cpu_vs_cpu = false;
    
    this.se = 0.75;
    this.bgm = 0.75;
    
    this.SEpool = [];
    this.cancelSE = AssetManager.get("sound","cancel");
    this.SEpool.push(this.cancelSE);
    this.chitSE = AssetManager.get("sound","chit");
    this.SEpool.push(this.chitSE);
    this.cursorSE = AssetManager.get("sound","cursor");
    this.SEpool.push(this.cursorSE);
    this.enterSE = AssetManager.get("sound","enter");
    this.SEpool.push(this.enterSE);
    this.fightSE = AssetManager.get("sound","fight");
    this.SEpool.push(this.fightSE);
    this.jhitSE = AssetManager.get("sound","jhit");
    this.SEpool.push(this.jhitSE);
    this.karaburiSE = AssetManager.get("sound","karaburi");
    this.SEpool.push(this.karaburiSE);
    this.sousaiSE = AssetManager.get("sound","sousai");
    this.SEpool.push(this.sousaiSE);
    this.readySE = AssetManager.get("sound","ready");
    this.SEpool.push(this.readySE);
    this.slashSE = AssetManager.get("sound","slash");
    this.SEpool.push(this.slashSE);
    this.todomeSE = AssetManager.get("sound","todome");
    this.SEpool.push(this.todomeSE);
    
    this.SEpool.forEach(function(se){
      se.volume=0.15*this.se;
    },this);
    
    this.BGMpool=[];
    this.lobbyBGM = AssetManager.get("sound","lobby");
    this.BGMpool.push(this.lobbyBGM);
    this.battleBGM = AssetManager.get("sound","battle");
    this.BGMpool.push(this.battleBGM);
    this.winJingle = AssetManager.get("sound","win");
    this.BGMpool.push(this.winJingle);
    this.loseJingle = AssetManager.get("sound","lose");
    this.BGMpool.push(this.loseJingle);
    this.BGMpool.forEach(function(bgm){
      bgm.volume=0.2*this.bgm;
    },this);
    
    // 背景
    this.bg = Sprite("bg25").addChildTo(this);
    this.bg1 = Sprite("bg25").addChildTo(this);
    this.bg2 = Sprite("bg25").addChildTo(this);
    
    this.bg.origin.set(0, 0); // 左上基準に変更
    this.bg1.origin.set(0,0);
    this.bg2.origin.set(0,0);
    this.bg1.x-=SCREEN_WIDTH;
    this.bg2.x+=SCREEN_WIDTH;
    
    this.fighters = DisplayElement().addChildTo(this);
    // プレイヤー
    this.player = GameObject(['yukari_origin'],'yukari_origin_ss',this.fighters,-300/FOUR,0,false);
    this.enemy = GameObject(['maki_origin'],'maki_origin_ss',this.fighters,300/FOUR,0,true);
    
    this.player.object.reverse=true;
    this.player.inputable=false;
    
    this.player.target=this.enemy;
    this.enemy.target=this.player;
    
    this.surface = DisplayElement().addChildTo(this);
    this.title = Sprite("title").addChildTo(this.surface);
    this.title.origin.set(0,0);
    this.title.x=10;
    this.title.y=10;
    
    this.menu1 = DisplayElement().addChildTo(this.surface);
    this.menu2 = DisplayElement().addChildTo(this.surface);
    this.m_center = DisplayElement().addChildTo(this.surface);
    
    
    this.clist1={};
    this.clist1["root"] = GameConsole("root",null,["charactor","color","entry"],this.menu1,50,this.player);
    this.clist1["charactor"] = GameConsole("charactor","root",["c_maki","c_yukari","back"],this.menu1,50,this.player);
    this.clist1["color_y"] = GameConsole("color_y","root",["origin","white","legacy","back"],this.menu1,50,this.player);
    this.clist1["color_m"] = GameConsole("color_m","root",["origin","white","bskin","back"],this.menu1,50,this.player);
    this.clist1["entry"] = GameConsole("entry","root",[],this.menu1,50,this.player);
    this.clist1["charactor"].parent.hide();
    this.clist1["color_y"].parent.hide();
    this.clist1["color_m"].parent.hide();
    this.clist1["entry"].parent.hide();
    
    
    this.clist2={};
    this.clist2["root"] = GameConsole("root",null,["charactor","color","entry"],this.menu2,190,this.enemy);
    this.clist2["charactor"] = GameConsole("charactor","root",["c_maki","c_yukari","back"],this.menu2,190,this.enemy);
    this.clist2["color_y"] = GameConsole("color_y","root",["origin","white","legacy","back"],this.menu2,190,this.enemy);
    this.clist2["color_m"] = GameConsole("color_m","root",["origin","white","bskin","back"],this.menu2,190,this.enemy);
    this.clist2["entry"] = GameConsole("entry","root",[],this.menu2,190,this.enemy);
    this.clist2["charactor"].parent.hide();
    this.clist2["color_y"].parent.hide();
    this.clist2["color_m"].parent.hide();
    this.clist2["entry"].parent.hide();
    
    this.clist_c={};
    this.clist_c["root"] = GameConsole("root",null,["tutorial","settings","credit","exit"],this.m_center,120);
    this.clist_c["settings"] = GameConsole("settings","root",["settings_t","game_settings","sound_settings","back_s"],this.m_center);
    this.clist_c["game_settings"] = GameConsole("game_settings","settings",["game_settings_t","game_num","deuce","cpu_vs_cpu","back_s"],this.m_center,0,this);
    this.clist_c["sound_settings"] = GameConsole("sound_settings","settings",["sound_settings_t","se","bgm","back_s"],this.m_center,0,this);
    this.clist_c["exit"] = GameConsole("exit","root",["exit_message","yes","no"],this.m_center,0,this);
    this.clist_c["credit"] = GameConsole("credit","root",[],this.m_center,0,this);
    this.clist_c["tutorial"] = GameConsole("tutorial","root",[],this.m_center,0,this);
    this.clist_c["credit"].parent.hide();
    this.clist_c["tutorial"].parent.hide();
    this.clist_c["settings"].parent.hide();
    this.clist_c["game_settings"].parent.hide();
    this.clist_c["sound_settings"].parent.hide();
    this.clist_c["exit"].parent.hide();
    
    var clists = [this.clist1,this.clist_c,this.clist2];
    var pointflag=true;
    var cursorSE = this.cursorSE;
    //this.pcflag=false;
    var conpstart = function(e){
      if(!clists[0]["entry"].parent.visible&&!clists[2]["entry"].parent.visible&&!clists[1]["settings"].parent.visible
      &&!clists[1]["exit"].parent.visible&&!clists[1]["credit"].parent.visible&&!clists[1]["tutorial"].parent.visible){
        var tl = e.interactive.app.touchList.touches;
        if(this.getParent().getParent().visible&&tl.length==1){
          pointflag=true;
          clists.some(function(clist){
              if(clist["root"].owner.alpha==1||clist["root"].owner.alpha==0.25){
                pointflag=true;
              }
              else{
                pointflag=false;
                return true;
              }
            });
          if(this.getParent().getParent().getParent().alpha==0.25&&pointflag){
            cursorSE.play();
            this.getParent().getParent().getParent().tweener.clear().set({alpha: 0.26}).to({alpha: 1},200,"easeOutQuart");
            clists.forEach(function(clist){
              if(clist["root"].owner.alpha==1){
                clist["root"].owner.tweener.clear().set({alpha: 0.99}).to({alpha: 0.25},200,"easeOutQuart");
              }
            });
          }
          else if(this.getParent().getParent().getParent().alpha==1&&pointflag){
            this.pcflag=true;
          }
        }
      }
    };
    var conpmove = function(e){
      if(this.getParent().getParent().visible&&this.pcflag){
        if(-6<this.getParent().y&&this.getParent().y<6){
          this.getParent().moveBy(0,e.pointer.deltaPosition.y);
        }
        if(this.getParent().y<=-6){
          this.getParent().y=-6;
        }
        else if(this.getParent().y>=6){
          this.getParent().y=6;
        }
      }
    }
    var conpend = function(e){
      if(this.getParent().getParent().visible&&this.pcflag){
        this.pcflag=false;
        if(this.getParent().y<=-6||6<=this.getParent().y){
          if(this.getParent().y<=-6){
            this.downflag=true;
          }
          else{
            this.upflag=true;
          }
        }
        else if(-1<=this.getParent().y&&this.getParent().y<=1){
          this.getParent().tweener.clear().to({y: 0},100,"easeOutQuart");
          this.enterflag=true;
        }
        else{
          this.getParent().tweener.clear().to({y: 0},100,"easeOutQuart");
        }
      }
    };
    for(con in this.clist1){
      this.clist1[con].dummy.setInteractive(true);
      this.clist1[con].dummy.onpointstart=conpstart;
      this.clist1[con].dummy.onpointmove=conpmove;
      this.clist1[con].dummy.onpointend=conpend;
    }
    for(con in this.clist2){
      this.clist2[con].dummy.setInteractive(true);
      this.clist2[con].dummy.onpointstart=conpstart;
      this.clist2[con].dummy.onpointmove=conpmove;
      this.clist2[con].dummy.onpointend=conpend;
    }
    for(con in this.clist_c){
      if(con=="root"){
        this.clist_c[con].dummy.setInteractive(true);
        this.clist_c[con].dummy.onpointstart=conpstart;
        this.clist_c[con].dummy.onpointmove = conpmove;
        this.clist_c[con].dummy.onpointend = conpend;
      }
    }
    this.menu2.alpha=0.25;
    this.m_center.alpha = 0.25;
    
    
    /*this.board_test = DisplayElement().addChildTo(this);
    this.backrect_test = RectangleShape({width:SCREEN_WIDTH*3/4,height:SCREEN_HEIGHT*3/4,fill:"#000",stroke:"false"}).addChildTo(this.board_test);
    this.label_test = Label({text:"Settings",y:-SCREEN_HEIGHT/4,fill:"#fff",fontFamily:"fantasy",fontSize:18}).addChildTo(this.board_test);
    this.label_test = Label({text:"Game Settings",y:0-10,fill:"#fff",fontFamily:"fantasy",fontSize:12}).addChildTo(this.board_test);
    this.label_test = Label({text:"Sound Settings",y:SCREEN_HEIGHT/6-10,fill:"#fff",fontFamily:"fantasy",fontSize:12}).addChildTo(this.board_test);
    this.label_test = Label({text:"Back",y:SCREEN_HEIGHT*2/6-10,fill:"#fff",fontFamily:"fantasy",fontSize:12}).addChildTo(this.board_test);
    this.backrect_test.alpha=0.5;
    this.board_test.tweener.clear().set({x:SCREEN_WIDTH/2,y:120,scaleX:0.1,scaleY:0.1}).to({x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/2,scaleX:1,scaleY:1},500,"easeOutQuart");
    */
    
    this.decolate = DisplayElement().addChildTo(this);
    
    this.hitpoints = [RectangleShape({originX:0.5,originY:0,x:5+5,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+12,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+19,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+26,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+33,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+40,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+47,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+54,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+61,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:5+68,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)];
    this.hitpoints.forEach(function(hp,i){
      hp.hide();
    },this);
    
    this.hitpoints2 = [RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-5,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-12,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-19,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-26,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-33,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-40,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-47,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-54,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-61,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)
    ,RectangleShape({originX:0.5,originY:0,x:-5+SCREEN_WIDTH-68,y:0,width:5,height:20,stroke:false,fill:"#f44"}).addChildTo(this.decolate)];
    this.hitpoints2.forEach(function(hp,i){
      hp.hide();
    },this);
    
    this.ready = Sprite("ready").addChildTo(this.decolate);
    this.fight = Sprite("fight").addChildTo(this.decolate);
    
    this.you_r = Sprite("you_r").addChildTo(this.decolate);
    this.you_b = Sprite("you_b").addChildTo(this.decolate);
    this.win = Sprite("win").addChildTo(this.decolate);
    this.lose = Sprite("lose").addChildTo(this.decolate);
    this.you_r.hide();
    this.you_b.hide();
    this.win.hide();
    this.lose.hide();
    this.decolate.hide();
    
    this.hanteilist = [];
    var _hanteis = ["hantei0","hantei1","hantei2","hantei3","hantei4","hantei5","hantei6","hantei7","hantei8","hantei9","hantei10","hantei11","hantei12","hantei13","hantei14","hantei15","hantei16","hantei17","hantei18","hantei19"
    ,"hantei20","hantei21","hantei22","hantei23","hantei24"
    ];
    (_hanteis.length).times(function(i){
      var tmp = AssetManager.get("json",_hanteis[i]);
      this.hanteilist.push(tmp.data);
    },this);
    this.hanteipool=[];
    
    this.karaburiflag1_p=false;
    this.karaburiflag2_p=false;
    this.karaburiflag1_e=false;
    this.karaburiflag2_e=false;
    
    
    this.lobbyBGM.loop=true;
    this.lobbyBGM.play();
    
    this.roundlabel = Label({fill:"#222",text:this.player.roundpoint+" - "+this.enemy.roundpoint,x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/8,fontFamily:"mypixel",fontSize:20}).addChildTo(this.decolate);
    
    this.fflag=false;
    this.pre_fflag=false;
    this.dflag=false;
    this.pre_dfalg=false;
    this.sflag=false;
    this.pre_sflag=false;
    
    this.controlobj=null;
    this.gameset = false;
    this.winobj = null;
  },
  
  // 更新
  update: function(app) {
    
    //console.log(this.clist1["root"].list.tweener.playing);
    var hpappear = function(i,owner){
      if(i<10){
        owner.hitpoints[i].show();
        owner.hitpoints[i].tweener.clear().wait(100).call(hpappear,owner,[i+1,owner]);
      }
    };
    var hpappear2 = function(i,owner){
      if(i<10){
        owner.hitpoints2[i].show();
        owner.hitpoints2[i].tweener.clear().wait(100).call(hpappear2,owner,[i+1,owner]);
      }
    };
    function Collision(h1,h2){
      if(h1.x1<h2.x2&&h2.x1<h1.x2&&h1.y1<h2.y2&&h2.y1<h1.y2){
        return true;
      }
      else return false;
    }
    
    var clists = [this.clist1,this.clist_c,this.clist2];
    var settingsflag=false;
    for(con in this.clist_c){
      if(con.match("settings")&&this.clist_c[con].parent.visible){
        settingsflag=true;
      }
      if((con == "credit"||con == "tutorial"||con == "exit")&&this.clist_c[con].parent.visible){
        settingsflag=true;
      }
    }
    if(this.surface.visible){
      if(!this.clist1["entry"].parent.visible&&!this.clist2["entry"].parent.visible&&!settingsflag){
        if(app.keyboard.getKeyDown("right")){
          clists.forEach(function(clist,i){
            if(clist["root"].owner.alpha==1){
              this.cursorSE.play();
              clist["root"].owner.tweener.clear().to({alpha: 0.25},200,"easeOutQuart");
              clists[(i+1)%clists.length]["root"].owner.tweener.clear().to({alpha: 1},200,"easeOutQuart");
            }
          },this);
        }
        else if(app.keyboard.getKeyDown("left")){
          clists.forEach(function(clist,i){
            if(clist["root"].owner.alpha==1){
              this.cursorSE.play();
              clist["root"].owner.tweener.clear().to({alpha: 0.25},200,"easeOutQuart");
              clists[(i-1)*(i-1<0?-(clists.length-1):1)]["root"].owner.tweener.clear().to({alpha: 1},200,"easeOutQuart");
            }
          },this);
        }
      }
      var conname;
      if(this.clist1["root"].owner.alpha==1){
        for(con in this.clist1){
          if(this.clist1[con].parent.visible){
            conname=this.clist1[con].update(app.pointer,app.keyboard,this);
            this.clist1[con].parent.hide();
          }
        }
        this.clist1[conname].parent.show();
      }
      if(this.clist2["root"].owner.alpha==1){
        for(con in this.clist2){
          if(this.clist2[con].parent.visible&&this.clist2[con].owner.alpha==1){
            conname=this.clist2[con].update(app.pointer,app.keyboard,this);
            this.clist2[con].parent.hide();
          }
        }
        this.clist2[conname].parent.show();
      }
      if(this.clist_c["root"].owner.alpha==1){
        for(con in this.clist_c){
          if(this.clist_c[con].parent.visible&&this.clist_c[con].owner.alpha==1){
            conname=this.clist_c[con].update(app.pointer,app.keyboard,this);
            this.clist_c[con].parent.hide();
          }
        }
        this.clist_c[conname].parent.show();
      }
    }
    var bgs = [];
    bgs.push(this.bg);
    bgs.push(this.bg1);
    bgs.push(this.bg2);
    var gos = [];
    gos.push(this.player);
    gos.push(this.enemy);
    this.player.update(app.pointer,app.pointers,app.keyboard,this.fighters);
    this.enemy.update(app.pointer,app.pointers,app.keyboard,this.fighters);
    //this.player2.update();
    //this.enemy2.update();
    
    (gos.length).times(function(i){
      if(gos[i].object.x<-430/FOUR){
        var tmp=0;
        tmp = -430/FOUR-gos[i].object.x;
        gos[i].object.x=-430/FOUR;
        (bgs.length).times(function(j){
          bgs[j].x+=tmp;
          if(bgs[j].x>SCREEN_WIDTH){
            var tmp2 = bgs[j].x;
            bgs[j].x = tmp2 - SCREEN_WIDTH*3;
          }
        },this);
        gos[i].target.object.x+=tmp;
        if(gos[i].target.object.x>430/FOUR){
          gos[i].target.object.x=430/FOUR;
        }
      }
      if(gos[i].object.x>430/FOUR){
        var tmp=0;
        tmp = 430/FOUR-gos[i].object.x;
        gos[i].object.x=430/FOUR;
        (bgs.length).times(function(j){
          bgs[j].x+=tmp;
          if(bgs[j].x<-SCREEN_WIDTH){
            var tmp2 = bgs[j].x;
            bgs[j].x = tmp2 + SCREEN_WIDTH*3;
          }
        },this);
        gos[i].target.object.x+=tmp;
        if(gos[i].target.object.x<-430/FOUR){
          gos[i].target.object.x=-430/FOUR;
        }
      }
    },this);
    
    
    
    
    this.hanteipool = [];
    this.player.updatehantei(this.hanteilist,this.hanteipool);
    this.enemy.updatehantei(this.hanteilist,this.hanteipool);
    
    (this.hanteipool.length).times(function(i){
      if(this.hanteipool[i].type==="attack_p"){
        this.karaburiflag2_p=false;
        this.karaburiflag1_p=true;
        (this.hanteipool.length).times(function(j){
          if(this.hanteipool[j].type==="attack_e"){
            if(Collision(this.hanteipool[i],this.hanteipool[j])){
              this.karaburiflag1_p=false;
              this.sousaiSE.play();
              this.player.sousai=true;
              this.enemy.sousai=true;
            }
          }
        },this);
        (this.hanteipool.length).times(function(j){
          if(this.hanteipool[j].type==="body_e"){
            if(Collision(this.hanteipool[i],this.hanteipool[j])){
              this.karaburiflag1_p=false;
              if(!this.player.hitflag&&this.enemy.hitpoint>0){
                if(!this.player.sousai&&!this.enemy.demo){
                  this.hitpoints2[this.enemy.hitpoint-1].hide();
                  this.enemy.hitpoint--;
                }
              this.enemy.damage(this);
              this.player.hitflag=true;
              }
              
            }
          }
        },this);
      }
      else if(this.hanteipool[i].type==="attack_e"){
        this.karaburiflag2_e=false;
        this.karaburiflag1_e=true;
        (this.hanteipool.length).times(function(j){
          if(this.hanteipool[j].type==="attack_p"){
            if(Collision(this.hanteipool[i],this.hanteipool[j])){
              this.karaburiflag1_e=false;
              this.player.sousai=true;
              this.enemy.sousai=true;
            }
          }
        },this);
        (this.hanteipool.length).times(function(j){
          if(this.hanteipool[j].type==="body_p"){
            if(Collision(this.hanteipool[i],this.hanteipool[j])){
              this.karaburiflag1_e=false;
              if(!this.enemy.hitflag&&this.player.hitpoint>0){
                if(!this.enemy.sousai&&!this.player.demo){
                  this.hitpoints[this.player.hitpoint-1].hide();
                  this.player.hitpoint--;
                }
              this.player.damage(this);
              this.enemy.hitflag=true;
              }
              
            }
          }
        },this);
      }
    },this);
    if(this.karaburiflag2_p&&!this.player.hitflag
    &&this.player.status!="damage"
    &&this.player.status!="jdamage"
    &&this.player.status!="sdamage"
    &&this.player.status!="counterdamage"){
      this.karaburiflag1_p=false;
      this.karaburiflag2_p=false;
      this.karaburiSE.play();
    }
    if(this.karaburiflag2_p&&(this.player.hitflag
    ||this.player.status=="damage"
    ||this.player.status=="jdamage"
    ||this.player.status=="sdamage"
    ||this.player.status=="counterdamage")){
      this.karaburiflag1_p=false;
      this.karaburiflag2_p=false;
    }
    if(this.karaburiflag2_e&&!this.enemy.hitflag
    &&this.enemy.status!="damage"
    &&this.enemy.status!="jdamage"
    &&this.enemy.status!="sdamage"
    &&this.enemy.status!="counterdamage"){
      this.karaburiflag1_e=false;
      this.karaburiflag2_e=false;
      this.karaburiSE.play();
    }
    if(this.karaburiflag2_e&&(this.enemy.hitflag
    ||this.enemy.status=="damage"
    ||this.enemy.status=="jdamage"
    ||this.enemy.status=="sdamage"
    ||this.enemy.status=="counterdamage")){
      this.karaburiflag1_e=false;
      this.karaburiflag2_e=false;
    }
    if(this.karaburiflag1_p)
      this.karaburiflag2_p=true;
    if(this.karaburiflag1_e)
      this.karaburiflag2_e=true;
    
    
    if((this.player.hitpoint==0||this.enemy.hitpoint==0)){
      this.dflag=true;
    }
    if(this.dflag&&!this.pre_dflag){
      this.decolate.tweener.clear().call(function(){
        gos.forEach(function(go,i){
          if(go.hitpoint==0){
            go.target.roundpoint++;
            if(!this.deuce&&go.target.roundpoint==this.gn){
              
              this.winobj=go.target;
              go.target.sfag=false;
              this.controlobj.inputable=false;
              this.controlobj.mode="safe";
              this.gameset=true;
            }
            if(this.deuce&&go.match&&go.target.roundpoint+1 >= this.gn){
              go.match = false;
              this.params.deuce++;
            }
            if(this.deuce && go.target.match){
              this.winobj = go.target;
              go.target.sfag=false;
              this.controlobj.inputable=false;
              this.controlobj.mode="safe";
              this.gameset = true;
            }
            if(this.deuce && go.target.roundpoint > go.roundpoint && go.target.roundpoint+1 >= this.gn){
              go.target.match = true;
            }
          }
          go.attackable=false;
        },this);
        app.fps=5;
      },this).wait(1000).call(function(){
        app.fps=30;
        
      },this).wait(1000).call(function(){
        this.roundlabel.text = gos[0].roundpoint+ " - " + gos[1].roundpoint;
        //console.log(gos[0].match,gos[0].roundpoint,gos[1].match,gos[1].roundpoint,this.gn);
        
        var leftHP = this.controlobj.hitpoint;
        var hit = 10-this.controlobj.target.hitpoint;
        var scores=[];
        scores.push({text: "hit",point:hit});
        scores.push({text: "yourHP",point:leftHP});
        if(leftHP == 10 && hit==10){
          scores.push({text: "stealth",point:1});
        }
        if(leftHP == 1 && hit == 10){
          scores.push({text: "by a hair",point:1});
        }
        var round = {scores:scores};
        this.rounds.push(round);
        //console.log(this.rounds);
        
        if(this.gameset){
          if(this.controlobj.object.name.match("yukari")){
            this.params.lastchara = "yukari";
          }
          else if(this.controlobj.object.name.match("maki")){
            this.params.lastchara = "maki";
          }
          var entry = {rounds: this.rounds};
          this.params.entries.push(entry);
          this.rounds=[];
          //console.log(this.params);
          if(this.controlobj == this.winobj){
            this.params.win++;
            this.battleBGM.stop();
            this.battleBGM.isplaying=false;
            this.winJingle.play();
            this.you_r.show();
            this.you_r.tweener.clear().set({y:20,x:-100}).to({x:SCREEN_WIDTH+this.you_r.width/2},2000,"easeOutInQuart").call(function(){this.you_r.hide();this.decolate.hide();},this);
            this.win.show();
            this.win.tweener.clear().set({y:40,x:SCREEN_WIDTH+100}).to({x:-this.win.width/2},2000,"easeOutInQuart").call(function(){this.win.hide();},this);
          }
          else{
            this.params.lose++;
            this.battleBGM.stop();
            this.battleBGM.isplaying=false;
            this.loseJingle.play();
            this.you_b.show();
            this.you_b.tweener.clear().set({y:20,x:-100}).to({x:SCREEN_WIDTH+this.you_b.width/2},2000,"easeOutInQuart").call(function(){this.you_b.hide();this.decolate.hide();},this);
            this.lose.show();
            this.lose.tweener.clear().set({y:40,x:SCREEN_WIDTH+100}).to({x:-this.lose.width/2},2000,"easeOutInQuart").call(function(){this.lose.hide();},this);
          }
        }
        if(this.winobj!=null){
          this.winobj.towinpose=true;
          this.winobj.sflag=false;
          this.winobj=null;
        }
        gos.forEach(function(go,i){
            go.hitpoint=10;
            if(!this.gameset&&go.status=="dead"){
              go.object_ss.gotoAndPlay("wakeup");
              go.statusupdate();
            }
            
        },this);
        if(!this.gameset)
          this.fflag=true;
        else{
         this.gameset=false;
        }
        this.dflag=false;
      },this);
    }
    gos.forEach(function(go,i){
      if(go.idolfromwinflag){
        this.sflag=true;
      }
    },this);
    if(this.sflag&&!this.pre_sflag){
      this.gameset=false;
      gos.forEach(function(go,i){
        go.match=false;
        go.roundpoint=0;
        if(go.status=="dead"){
          go.object_ss.gotoAndPlay("wakeup");
          go.statusupdate();
        }
      },this);  
      this.sflag=false;
      gos.forEach(function(go){
        go.attackable=true;
        go.target.attackable=true;
        go.demo=true;
        go.target.demo=true;  
      });
      this.battleBGM.stop();
      this.battleBGM.isplaying=false;
      this.lobbyBGM.loop=true;
      this.lobbyBGM.play();
      this.lobbyBGM.isplaying=true;
      this.hitpoints.forEach(function(hp){
        hp.hide();
      });
      this.hitpoints2.forEach(function(hp){
        hp.hide();
      });
      //this.decolate.hide();
      this.surface.show();
      if(this.clist1["entry"].parent.visible){
        this.clist1["entry"].parent.hide();
        this.clist1["root"].parent.show();
      }
      if(this.clist2["entry"].parent.visible){
        this.clist2["entry"].parent.hide();
        this.clist2["root"].parent.show();
      }
    }
    var clists2 = [this.clist1,this.clist2];
    
    clists2.forEach(function(clist,i){
      if(clist["entry"].parent.visible){
        var obj=clist["entry"].controlobj;
        if(obj.mode=="standby"&&obj.status=="idol"&&obj.target.mode=="standby"&&obj.target.status=="idol"){
          this.roundlabel.text = gos[0].roundpoint+ " - " + gos[1].roundpoint;
          this.fflag = true;
          this.controlobj = obj;
        }
      }
    },this);
    if(this.fflag&&!this.pre_fflag){
      this.lobbyBGM.stop();
      this.lobbyBGM.isplaying=false;
      this.battleBGM.loop=true;
      if(!this.battleBGM.isplaying)
        this.battleBGM.play();
      this.battleBGM.isplaying=true;
      this.surface.hide();
      this.decolate.show();
      
      hpappear(0,this);
      hpappear2(0,this);
      this.ready.show();
      this.fight.hide();
      this.readySE.play();
      this.ready.tweener.clear().set({x: SCREEN_WIDTH/2,y: -18}).to({y: SCREEN_HEIGHT+18},1000,"easeOutInQuart").call(function(){
        this.ready.hide();
        this.fight.show();
        this.decolate.tweener.clear().wait(100).call(function(){this.fightSE.play();},this);
        this.fight.tweener.clear().set({x: SCREEN_WIDTH/2,y: -18}).to({y: SCREEN_HEIGHT+18},1000,"easeOutInQuart").call(function(){
          this.fight.hide();
          if(this.controlobj!=null){
            if(!this.cpu_vs_cpu)
              this.controlobj.inputable=true;
            else
              this.controlobj.mode="safe";
            this.controlobj.demo=false;
            this.controlobj.target.mode="safe";
            this.controlobj.target.demo=false;
          }
          gos.forEach(function(go,i){
            go.attackable=true;
          });
          this.fflag=false;
        },this);
      },this);
    }
    //console.log(this.enemy.mode,this.enemy.sitcounter,this.enemy.sit,this.enemy.input.down);
     //console.log(app.canvas.miterLimit);
 this.pre_fflag=this.fflag;
 this.pre_dflag=this.dflag;
 this.pre_sflag=this.sflag;
  }
});


phina.define('myResultScene', {
  superClass: 'phina.display.DisplayScene',
  /**
   * @constructor
   */
  init: function(params) {
    params = ({}).$safe(params, phina.game.ResultScene.defaults);
    this.superInit(params);
    
    var chara="reslut_yukari";
    
    if(params.lastchara=="yukari"){
      chara="result_yukari";
    }
    else if(params.lastchara == "maki"){
      chara="result_maki";
    }
    
    var sprite = Sprite(chara).addChildTo(this);
    sprite.x=0;
    sprite.y=12;
    sprite.origin.set(0,0);
    Label({originX:0,originY:0,y:-10,text:"Thank you for playing !",fontSize:20,fontFamily:"mypixel",fill:"#fff"}).addChildTo(this);
    this.scoreclip = DisplayElement().addChildTo(this);
    this.scoreclip.clip = function(canvas){
      canvas.beginPath();
      canvas.rect(80,20,160,80);
    };
    var ite =0;
    this.allappear = false;
    this.scoreboard = DisplayElement({originX:0,originY:0,x:80,y:20,width:160,height:80}).addChildTo(this.scoreclip);
    this.scoreboard.setInteractive(true);
    var self = this;
    this.scoreboard.onpointmove = function(e){
      if(self.allappear&&(this.y+e.pointer.deltaPosition.y>=-(this.height-80)+10&&this.y+e.pointer.deltaPosition.y<=20))
        this.moveBy(0,e.pointer.deltaPosition.y);
      else if(self.allappear&&this.y+e.pointer.deltaPosition.y<-(this.height-80)+10){
        this.y=-(this.height-80)+10;
      }
      else if(self.allappear&&this.y+e.pointer.deltaPosition.y>20){
        this.y=20;
      }
    };
    this.results = [];
    var total=0;
    params.entries.forEach(function(entry,i){
      this.results.push(Label({originX:0,originY:0,x:0,y:-10+ite*10,text:"entry " +(i+1),fill:"#fff",fontSize:16,fontFamily:"mypixel"}).addChildTo(this.scoreboard));
      ite++;
      entry.rounds.forEach(function(round,j){
        this.results.push(Label({originX:0,originY:0,x:3,y:-10+ite*10,text:"round " +(j+1),fill:"#fff",fontSize:16,fontFamily:"mypixel"}).addChildTo(this.scoreboard));
        ite++;
        round.scores.forEach(function(score){
          var color = "#fff";
          if(score.text == "stealth" || score.text == "by a hair"){
            color = "#faf";
          }
          var de = DisplayElement().addChildTo(this.scoreboard);
          Label({originX:0,originY:0,x:6,y:-10+ite*10,text:score.text +":",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
          Label({originX:1,originY:0,x:90,y:-10+ite*10,text:score.point,fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
          Label({originX:0,originY:0,x:75,y:-10+ite*10,text:"x",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
          var point;
          switch(score.text){
            case "hit":
              point = 100;
              break;
            case "yourHP":
              point =10;
              break;
            case "by a hair":
              point = 1000;
              break;
            case "stealth":
              point = 2000;
              break;
          }
          Label({originX:1,originY:0,x:130,y:-10+ite*10,text:point+"=",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
          Label({originX:1,originY:0,x:160,y:-10+ite*10,text:score.point*point,fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
          total += score.point*point;
          ite++;
          this.results.push(de);
        },this);
      },this);
    },this);
    var color ="#fff";
    var de = DisplayElement().addChildTo(this.scoreboard);
    Label({originX:0,originY:0,x:3,y:-10+ite*10,text:"win:",fill:"#fff",fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:1,originY:0,x:90,y:-10+ite*10,text:params.win,fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:0,originY:0,x:75,y:-10+ite*10,text:"x",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    var point=1000;
    Label({originX:1,originY:0,x:130,y:-10+ite*10,text:point+"=",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:1,originY:0,x:160,y:-10+ite*10,text:params.win*point,fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    total += params.win*point;
    ite++;
    this.results.push(de);
    de = DisplayElement().addChildTo(this.scoreboard);
    Label({originX:0,originY:0,x:3,y:-10+ite*10,text:"lose:",fill:"#fff",fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:1,originY:0,x:90,y:-10+ite*10,text:params.lose,fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:0,originY:0,x:75,y:-10+ite*10,text:"x",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    var point=1;
    Label({originX:1,originY:0,x:130,y:-10+ite*10,text:point+"=",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:1,originY:0,x:160,y:-10+ite*10,text:params.lose*point,fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    total += params.lose*point;
    ite++;
    this.results.push(de);
    de = DisplayElement().addChildTo(this.scoreboard);
    Label({originX:0,originY:0,x:3,y:-10+ite*10,text:"deuce:",fill:"#fff",fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:1,originY:0,x:90,y:-10+ite*10,text:params.deuce,fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:0,originY:0,x:75,y:-10+ite*10,text:"x",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    var point=100;
    Label({originX:1,originY:0,x:130,y:-10+ite*10,text:point+"=",fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    Label({originX:1,originY:0,x:160,y:-10+ite*10,text:params.deuce*point,fill:color,fontSize:16,fontFamily:"mypixel"}).addChildTo(de);
    total += params.deuce*point;
    ite++;
    this.results.push(de);
    this.scoreboard.height = ite*10;
    
    this.results.forEach(function(de){
      de.hide();
    },this);
    
    this.totalscore = DisplayElement().addChildTo(this);
    Label({originX:0,originY:0,x:100,y:85,text:"Total:",fill:color,fontSize:20,fontFamily:"mypixel"}).addChildTo(this.totalscore);
    Label({originX:1,originY:0,x:240,y:85,text:total,fill:color,fontSize:20,fontFamily:"mypixel"}).addChildTo(this.totalscore);
    this.totalscore.hide();
    var resultappear =function(i){
      self.results[i].show();
      if(7<=i){
        self.scoreboard.y-=10;
      }
      if(i<self.results.length-1){
        self.results[i].tweener.clear().wait(100).call(resultappear,self,[i+1]);
      }
      else{
        self.allappear=true;
        self.totalscore.show();
        self.b.show();
      }
    };
    resultappear(0);
    
    var message = params.message.format(params);

    this.backgroundColor = params.backgroundColor;
    this.b= DisplayElement().addChildTo(this);
    this.b.hide();
    this.tweetb = Button({
      text: "Tweet",
      width: 40,
      height: 16,
      fontColor: params.fontColor,
      fontSize: 16,
      cornerRadius: 6,
      fontFamily:"mypixel",
      fill: 'rgba(240, 240, 240, 0.5)',
      // stroke: '#aaa',
      // strokeWidth: 2,
      x: 130,
      y: 123,
    }).addChildTo(this.b);
    this.replayb = Button({
      text: 'Replay',
      width: 40,
      height: 16,
      fontColor: params.fontColor,
      fontSize: 16,
      cornerRadius: 6,
      fontFamily:"mypixel",
      fill: 'rgba(240, 240, 240, 0.5)',
      x: 200,
      y: 123,
    }).addChildTo(this.b);
    this.replayb.onpush = function() {
      if(this.visible){
        self.exit();
      }
    };
    

    this.tweetb.onclick = function() {
      if(this.visible){
        var text = 'Total: {0}\n{1}'.format(total, message);
        var url = phina.social.Twitter.createURL({
          text: text,
          hashtags: params.hashtags,
          url: params.url,
        });
        window.open(url, 'share window', 'width=480, height=320');
      }
    };
  },

  _static: {
    defaults: {
      score: 16,

      message: 'this is phina.js project.',
      hashtags: 'phina_js,game,javascript',
      url: phina.global.location && phina.global.location.href,

      fontColor: 'white',
      backgroundColor: 'hsl(200, 80%, 64%)',
      backgroundImage: '',
    },
  },

});
phina.define('mySplashScene', {
  superClass: 'phina.display.DisplayScene',

  init: function(options) {
    var defaults = phina.game.SplashScene.defaults;
    this.superInit(options);

    this.backgroundColor = "#efe";

    this._init();
    /*var texture = phina.asset.Texture();
    texture.load(defaults.imageURL).then(function() {
      this._init();
    }.bind(this));
    this.texture = texture;*/
  },

  _init: function() {
    this.sprite = phina.display.Sprite("logo").addChildTo(this);
    this.sprite.scaleX = 0.28;
    this.sprite.scaleY = 0.28;
    this.sprite.setPosition(this.gridX.center(), this.gridY.center());
    this.sprite.alpha = 0;
    var zunko = AssetManager.get("sound","splash_zunko");
    var maki = AssetManager.get("sound","splash_maki");
    var yukari = AssetManager.get("sound","splash_yukari");
    var splashes = [zunko,maki,yukari];
    var Iterator = Math.random();
    if(Iterator < 1/3){
      Iterator = 0;
      this.backgroundColor = "#cfc";
    }
    else if(Iterator < 2/3){
      Iterator = 1;
      this.backgroundColor = "#ffc";
    }
    else {
      Iterator = 2;
      this.backgroundColor = "#ecf";
    }
    this.splashSE = splashes[Iterator];
    
    this.sprite.tweener
      .clear()
      .to({alpha:1}, 500, 'easeOutCubic')
      .call(function(){
        this.splashSE.play();
      },this)
      .wait(4000)
      .to({alpha:0}, 500, 'easeOutCubic')
      .wait(250)
      .call(function() {
        this.exit();
      }, this)
      ;
  },

  _static: {
    defaults: {
      imageURL: 'https://rawgit.com/phi-jp/phina.js/develop/logo.png',
    },
  },
});

/*
 * メイン処理
 */
phina.main(function() {
  // アプリケーションを生成
  var app = GameApp({
     scenes: [
        {
          className: 'mySplashScene',
          label: 'splash',
          nextLabel: "main"
        },
        {
          label: "main", // ラベル。参照用
          className: "MainScene", // シーンAのクラス名
        },
        {
          label: "Result",
          className: "myResultScene",
          nextLabel: "splash"
        }
      ],
    startLabel: 'splash',   // MainScene から開始
    width: SCREEN_WIDTH,  // 画面幅
    height: SCREEN_HEIGHT,// 画面高さ
    assets: ASSETS,       // アセット読み込み
  });
  //app.enableStats();
  // 実行
  app.run();
});</script>
  </body>
</html>

